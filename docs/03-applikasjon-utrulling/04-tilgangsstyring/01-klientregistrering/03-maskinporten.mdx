# Maskinporten

For √• registrere en klient i Maskinporten, kan du enten gj√∏re det i Digdir sin [selvbetjeninsl√∏sning](https://sjolvbetjening.samarbeid.digdir.no/login) eller
gjennom Kubernetes-operatoren [Digdirator](https://https://github.com/nais/digdirator). Digdirator er en Kubernetes-operator utviklet av NAV sitt plattformteam ([NAIS](https://nais.io)) som skal gj√∏re det enkelt √• deklarativt sette opp og vedlikeholde
integrasjoner mot [Digdir](https://docs.digdir.no) sine systemer. Dette inkluderer **ID-Porten**-integrasjoner og **Maskinporten**-integrasjoner, men per n√• **ikke** **Annsattporten**-integrasjoner.

:::caution
Digdirator st√∏tter kun klientregistreringer mot ID-porten og Maskinporten. For Ansattporten m√• klientregistreringer gj√∏res manuelt i Digdir sin [selvbetjeningsl√∏sning](https://sjolvbetjening.samarbeid.digdir.no/login).
:::

## üß™ Testmilj√∏ for Maksinporten

Digdir tilbyr Maskinporten i et testmilj√∏, der du kan teste applikasjonen din med syntetiske organisasjoner. 
For √• registrere en klient mot Maskinporten sitt testmilj√∏ s√• kan du enten gj√∏re det i Digdir sin [selvbetjeningsl√∏sning i test](https://sjolvbetjening.test.samarbeid.digdir.no/login) 
eller opprette en `MaskinportenClient`-ressurs i dev-clustrene til SKIP, i.e. `atgcp1-dev` eller `atkv3-dev`.

## ü§ñ `MaskinportenClient`

En `MaskinportenClient` er en CRD som lar brukere deklarativt opprette og vedlikeholde Maskinporten-klientregistreringer.

<details>
    <summary><strong>spec</strong> _(object, required)_ ‚Äì Spesifikasjon til `MaskinportenClient`</summary>

    <p><strong>secretName</strong> _(string, required)_ ‚Äì Navnet p√• den resulterende `Secret`-ressursen som vil bli opprettet.</p>
    <p><strong>clientName</strong> _(string, optional)_ ‚Äì Navnet p√• klienten registrert hos DigDir. Vises under innlogging for brukerorienterte flyter, og er ellers en lesbar m√•te √• skille mellom klienter i DigDirs selvbetjeningsportal.</p>
    <details>
        <summary><strong>scopes</strong> _([]object, optional)_ ‚Äì Definerer hvilke scopes applikasjonen konsumerer og hvilke den eksponerer.</summary>
        <details>
            <summary><strong>consumes</strong> _([]object, optional)_ ‚Äì En liste med scopes din klient kan foresp√∏rre tilgang til.</summary>
            <p><strong>name</strong> _(string, required)_ ‚Äì Scopene som applikasjonen konsumerer for √• f√• tilgang til en ekstern organisasjons API.</p>
        </details>
        <details>
            <summary><strong>exposes</strong> _([]object, optional)_ ‚Äì En liste med scopes din applikasjon √∏nsker √• eksponere til andre organisasjoner hvor tilgang er basert p√• organisasjonsnummer.</summary>
            <p><strong>enabled</strong> _(bool, required)_ ‚Äì Hvis `true`, s√• er detkonfigurerte scopet tilgjengelig for bruk og til √• bli konsumert av organisasjoner som har f√•tt godkjent tilgang.</p>
            <p><strong>name</strong> _(string, p√•krevd)_ ‚Äì Det faktiske sub-scopet kombinert med `product`.</p>
            <p><strong>product</strong> _(string, valgfritt)_ ‚Äì Produktomr√•de tilknyttet scopet. Dette vil inkluderes i resultatet: `org:<product><name>`.</p>
            <p><strong>atMaxAge</strong> _(int, valgfritt)_ ‚Äì Maksimal tillatt levetid for token i sekunder. Defaulter til 30 sekunder.</p>
            <p><strong>allowedIntegrations</strong> _([]string, valgfritt)_ ‚Äì Liste over tillatte integrasjonstyper for dette eksponerte omfanget. Defaulter til `maskinporten`.</p>
            <details>
                <summary><strong>consumers</strong> _([]object, valgfritt)_ ‚Äì Liste over eksterne konsumenter som har tilgang til √• konsumere dette scopet og som kan foresp√∏rre `access_token`.</summary>
                <p><strong>orgno</strong> ‚Äì Det eksterne organisasjonsnummeret.</p>
                <p><strong>name</strong> ‚Äì Beskrivende felt brukt utelukkende for oversikt.</p>
            </details>
            <p><strong>accessibleForAll</strong> ‚Äì Tillater alle organisasjoner √• f√• tilgang til scopet.</p>
            <p><strong>delegationSource</strong> ‚Äì Delegasjonskilde for scopet. Default er tomt, noe som betyr at ingen delegasjon er tillatt.</p>
            <p><strong>separator</strong> ‚Äì Tegnet som skiller `product` og `name` i det endelige scopet. Resultatet blir da `<prefix>:<product><separator><name>`. Defaulter til `:` med mindre `name` inneholder `/`, i det tilfellet defaultes det til `/`.</p>
            <p><strong>visibility</strong> ‚Äì Kontrollerer synligheten til scopet. Offentlige scopes er synlige for alle, mens private scopes kun er synlige for organisasjonen som eier scopet og organisasjoner som har f√•tt tilgang som konsumenter. Defaulter til `public`. Tillatte verdier: `private`, `public`.</p>
        </details>
    </details>
</details>

F√∏lgende eksempel oppretter en klientintegrasjon mot Maskinporten og definerer scopet `innsyn`.
Den setter HUSL√òS HURTIG TIGER AS og KOSTBAR LEKKER APE AS som godkjente konsumenter av scopet.
N√•r registrering er fullf√∏rt vil Digdirator opprette Kubernetes-hemmeligheten `maskinporten-secret` i namespacet `tilgangsstyring-main`.

```yaml title="Klientregistrering mot Maskinporten med Digdirator"
apiVersion: nais.io/v1
kind: MaskinportenClient
metadata:
  name: test-client
  namespace: tilgangsstyring-main
spec:
  clientName: innsikt-secure-deltashare
  scopes:
    exposes:
      - enabled: true
        name: "innsyn"
        product: "Produktomr√•de"
        consumers:
          - name: HUSL√òS HURTIG TIGER AS
            orgno: "987654321"
          - name: KOSTBAR LEKKER APE AS
            orgno: "123456789"
  secretName: maskinporten-secret
```

```yaml title="Hemmelighet opprettet av Digdirator etter fullf√∏rt klientregistrering"
apiVersion: v1
kind: Secret
metadata:
  name: maskinporten-secret
  namespace: tilgangsstyring-main
data:
  MASKINPORTEN_CLIENT_ID: ++++++++
  MASKINPORTEN_CLIENT_JWK: ++++++++
  MASKINPORTEN_ISSUER: ++++++++
  MASKINPORTEN_JWKS_URI: ++++++++
  MASKINPORTEN_SCOPES: ++++++++
  MASKINPORTEN_TOKEN_ENDPOINT: ++++++++
  MASKINPORTEN_WELL_KNOWN_URL: ++++++++
type: Opaque
```