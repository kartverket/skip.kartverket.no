# Eksempeloppsett av Ztoperator

For √• illustrere hvordan en Ztoperator-`AuthPolicy` fungerer, kan vi se p√• f√∏lgende eksempel-applikasjon kalt [demo-app](https://demo-app.atgcp1-sandbox.kartverket.cloud/). `demo-app` er en Python-applikasjon med et enkelt REST-API, som ogs√• distribuerer en Single Page Application (SPA). I kildekoden til `demo-app` finnes det **ingen** mekanismer for tilgangsstyring eller beskyttelse av REST-API-endepunktene, og den har heller **ikke** funksjonalitet for √• logge inn brukere med Microsoft Entra ID. Ztoperator-`AuthPolicyen` tar seg av alt dette.

Kildekoden til `demo-app` kan finnes p√• [github.com/kartverket/skip-tilgangsstyring-demo](https://github.com/kartverket/skip-tilgangsstyring-demo). Dette repoet lar deg ogs√• teste og verifisere oppf√∏rselen til Ztoperator med et lokalt Kubernetes-cluster som likner p√• SKIP.

`demo-app` best√•r av _tre_ ressurser:
- En `AzureAdApplication` som setter opp en klientregistrering mot Kartverkets Microsoft Entra ID.
- En Skiperator-`Application` som enkelt ruller ut applikasjonen p√• SKIP.
- En Ztoperator-`AuthPolicy` som h√•ndhever at angitte endepunkter **m√•** presentere et gyldig `access_token`, og i tillegg logger inn brukere der det er angitt.

Manifestene for disse ressursene finner du i [tilgangsstyring-apps p√• GitHub](https://github.com/kartverket/tilgangsstyring-apps/tree/main/env/atgcp1-sandbox/ztoperator-demo).

## üîπ `AzureAdApplication`

F√∏r man g√•r i gang med √• sette opp en Ztoperator-`AuthPolicy` m√• man ha en klienregistrering opprettet hos en OAuth 2.0 identitetstilbyder. Ettersom `demo-app` er ment for intern bruk av Kartverket-ansatte, s√• er Microsoft Entra ID en passende identitetstilbyder. En `AzureAdApplication` kan brukes for √• opprette klientregistreringen, og f√∏lgende manifest oppretter en. Den er konfigurert til √• tillate alle brukere innenfor Kartverket's Entra ID tenant, og har en redirect-url som peker til applikasjonen sin konfiguererte redirect-url. Dette er noe vi senere konfigurerer i Ztoperator-`AuthPolicyen`, og Ztoperator h√•ndterer dette endepunktet for oss. Etter √• ha opprettet en klientregistrering i Microsoft Entra ID oppretter Azurerator ogs√• en Kubernetes-hemmelighet kalt `entraid-secret`. Klientregistreringen kan ses i [Azure Portal](https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/dcc29452-1fbc-4805-aeb9-cdb8f4e62147/isMSAApp~/false).

:::note
Redirect-url er noe `demo-app` ikke trenger √• forholde seg til. Ztoperator-`AuthPolicy` konfigures med en redirect-url n√•r man konfigurerer innlogging av brukere, og h√•ndterer [callbacks i authorization code flow](https://datatracker.ietf.org/doc/html/rfc6749#section-1.3.1).
:::

```yaml title="azureadapplication.yaml"
apiVersion: nais.io/v1
kind: AzureAdApplication
metadata:
  name: entraid-reg
  namespace: ztoperator-demo
spec:
  claims:
    groups:
      - id: a6578085-e0ee-4168-bf97-1b3026f6f3bd # Kartverket@kartverket.no
  replyUrls:
    - url: https://demo-app.atgcp1-sandbox.kartverket.cloud/oauth2/callback
  secretName: entraid-secret
```

```yaml title="Resulterende hemmelighet opprettet av Azurerator"
apiVersion: v1
kind: Secret
metadata:
  name: entraid-secret
  namespace: ztoperator-demo
type: Opaque
data:
  AZURE_APP_CERTIFICATE_KEY_ID: ++++++++
  AZURE_APP_CLIENT_ID: ++++++++
  AZURE_APP_CLIENT_SECRET: ++++++++
  AZURE_APP_JWK: ++++++++
  AZURE_APP_JWKS: ++++++++
  AZURE_APP_NEXT_CERTIFICATE_KEY_ID: ++++++++
  AZURE_APP_NEXT_CLIENT_SECRET: ++++++++
  AZURE_APP_NEXT_JWK: ++++++++
  AZURE_APP_NEXT_PASSWORD_KEY_ID: ++++++++
  AZURE_APP_PASSWORD_KEY_ID: ++++++++
  AZURE_APP_PRE_AUTHORIZED_APPS: ++++++++
  AZURE_APP_TENANT_ID: ++++++++
  AZURE_APP_WELL_KNOWN_URL: ++++++++
  AZURE_OPENID_CONFIG_ISSUER: ++++++++
  AZURE_OPENID_CONFIG_JWKS_URI: ++++++++
  AZURE_OPENID_CONFIG_TOKEN_ENDPOINT: ++++++++
```

## ü§ñ Skiperator-`Application`

`demo-app` er bygget til et Docker-image og lastet opp p√• GitHub Container Registry med f√∏lgende image-url: `ghcr.io/kartverket/skip-tilgangsstyring-demo`. Den kan da deployes p√• SKIP med f√∏lgende manifest og n√•s p√• `https://demo-app.atgcp1-sandbox.kartverket.cloud`.

Den uthevede delen av koden er viktig for at innlogging av sluttbrukere skal fungere. Hvorfor denne konfigurasjonen er viktig etterlates som en oppgave for leseren. Det brukeren *m√•* forholde seg til er hvilket `secretName` det skal refereres til. Dette m√• matche en Kuberenetes-hemmelighet som Ztoperator oppretter som har navneformatet `<NAVN P√Ö AUTHPOLICY>-envoy-secret`. Ettersom `demo-app` sin Ztoperator-`AuthPolicy` heter `auth-policy`, blir det korrekt med `"secretName": "auth-policy-envoy-secret"`.

```yaml title="demo-app.yaml"
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: demo-app
  namespace: ztoperator-demo
spec:
// diff-add-start
  podSettings:
    annotations:
      sidecar.istio.io/userVolume: '[
        {
          "name": "istio-oauth2",
          "secret": {
            "secretName": "auth-policy-envoy-secret" # üëà M√• matche <NAVN P√Ö AUTHPOLICY>-envoy-secret
          }
        }
      ]'
      sidecar.istio.io/userVolumeMount: '[
        {
          "name": "istio-oauth2",
          "mountPath": "/etc/istio/config",
          "readonly": true
        }
      ]'
// diff-add-end
  image: ghcr.io/kartverket/skip-tilgangsstyring-demo@sha256:cde1805d4e87b99a6d8d73fd6ed6666eaef1691a598f0377d3a716366cc4c9e8
  port: 5000
  ingresses:
    - demo-app.atgcp1-sandbox.kartverket.cloud
```

## ‚õîÔ∏è Ztoperator-`AuthPolicy`

Vi har n√• registrert en klient hos Microsoft Entra ID ved hjelp av Azurerator, og spunnet opp `demo-app`som en Skiperator-`Application`. Det siste steget er n√• √• beskytte applikasjonen med en Ztoperator-`AuthPolicy`. F√∏lgende manifest beskytter `demo-app` og h√•ndterer innlogging av brukere opp mot Microsoft Entra ID. Under g√•r vi gjennom hvordan og hvorfor vi har konfigurert Ztoperator-`AuthPolicy` som vi har gjort.

```yaml title="auth-policy.yaml"
apiVersion: ztoperator.kartverket.no/v1alpha1
kind: AuthPolicy
metadata:
  name: auth-policy
  namespace: ztoperator-demo
spec:
  enabled: true
  selector:
    matchLabels:
      app: demo-app
  wellKnownURI: https://login.microsoftonline.com/7f74c8a2-43ce-46b2-b0e8-b6306cba73a3/v2.0/.well-known/openid-configuration
  audience:
    - dcc29452-1fbc-4805-aeb9-cdb8f4e62147
  ignoreAuthRules:
    - paths:
        - /*
  authRules:
    - paths:
        - /api/beskyttet*
      methods:
        - POST
      denyRedirect: true
    - paths:
        - /beskyttet
  autoLogin:
    enabled: true
    loginPath: /login
    logoutPath: /logout
    redirectPath: /oauth2/callback
    scopes:
      - dcc29452-1fbc-4805-aeb9-cdb8f4e62147/.default
  oAuthCredentials:
    clientIDKey: AZURE_APP_CLIENT_ID
    clientSecretKey: AZURE_APP_CLIENT_SECRET
    secretRef: entraid-secret
  outputClaimToHeaders:
    - claim: preferred_username
      header: x-email
    - claim: name
      header: x-name
```

### `spec.enabled`

`spec.enabled` lar deg toggle om tilgangsstyring skal v√¶re aktivert eller ikke.

### `spec.selector`

`spec.selector` spesifiserer hvilke `pod`-er som skal beskyttes. N√•r man deployer en applikasjon med Skiperator s√• vil alle `pod`-er f√• labelen `app: <NAVN P√Ö SKIPERTOR-APPLICATION>`.

### `spec.wellKnownURI`

`spec.wellKnownURI` trengs for √• utf√∏re [OpenID Connect Discovery](https://swagger.io/docs/specification/v3_0/authentication/openid-connect-discovery/) og hente ut relevant informasjon om identitetstilbyderren brukt under autentisering. Det er her man knytter Ztoperator-`AuthPolicy` til en identitetstilbyder.

### `spec.audience`

`spec.audience` spesifiserer tiltenkt mottaker av aksess-tokenet. Dette er typisk en klient-ID eller en annen unik identifikator knyttet til klientregistreringen utf√∏rt tidligere. Dette feltet et viktig √• inkludere for √• skille klientregistreringer hos en identitetstilbyder fra andre. `spec.audience` sikrer at kun din klientregistrering kan bruke tokenet til √• aksessere applikasjonens beskyttede endepunkter.

### `spec.ignoreAuthRules`

I utgangspunktet er alle endepunkter mot `demo-app` _√•pne_, noe som angis med `paths: [/*]`. N√•r HTTP-verb ikke er spesifisert, gjelder regelen for alle metoder. Dersom et endepunkt ikke er eksplisitt definert ‚Äì eller det finnes overlapp mellom `spec.ignoreAuthRules` og `spec.authRules` ‚Äì vil Ztoperator alltid falle tilbake til √• beskytte endepunktet.

### `spec.authRules`

`POST` mot endpunktene `/api/beskyttet*` (`/api/beskyttet` og alle under-stier) skal v√¶re _beskyttet_. Ettersom kall mot `/api/beskyttet*` gj√∏res av en [Single Page Application i en AJAX-request](https://www.w3schools.com/xml/ajax_intro.asp), har man ikke muligheten til √• f√∏lge `302 Redirect` og logge inn brukeren automatisk. For √• l√∏se dette kan man spesifisere `denyRedirect: true` for √• forhindre at Ztoperator returnerer en `302 Redirect` (den sender da en `401 Unauthorized` i stedet), og heller omdirigere brukeren selv i frontend-koden til den konfigurerte innloggingsstien (`/login` i dette tilfellet). Stien `/beskyttet` skal ogs√• beskyttes, og ettersom det ikke spesifiseres `denyRedirect: true` vil uautentiserte brukere automatisk bli omdirigert til innlogging mot Microsoft Entra ID.

### `spec.autoLogin`

`spec.autoLogin` lar deg konfigurere innlogging mot identitetstilbyderen. Innlogging vil bli gjort automatisk hvis brukere aksesserer beskyttede endepunkt uten en sesjon (med mindre `spec.authRules[].denyRedirect` er satt til `true`). I tillegg konfigureres det en dedikert innloggingssti som brukere kan navigeres til for √• starte en inlogget sesjon.

- `spec.autoLogin.enabled` lar deg toggle om innlogging skal v√¶re aktivert eller ikke.
- `spec.autoLogin.loginPath` spesifiserer hvilken sti man skal aksessere for √• starte en innlogget sesjon. Etter vellykket innlogging vil en foresp√∏rsel sendes til den konfigurerte innloggingsstien i applikasjonen din, og det er da opp til deg √• h√•ndtere hva som skal skje.
- `spec.autoLogin.logoutPath` spesifiserer hvilken sti man skal aksessere for √• logge ut brukeren lokalt og opp mot den konfigurerte identitetstilbyderen ([RP-initiated logout](https://openid.net/specs/openid-connect-rpinitiated-1_0.html)). Etter vellykket utlogging vil brukeren bli omdirigert til nettsiden sin rotsti (dvs. `https://<HOST>/`).
- `spec.autoLogin.redirectPath` spesifiserer omdirigeringssti brukt under _Authorization Code Flow_. Dette er en sti som du **ikke** tregner √• h√•ndtere i applikasjonskoden din, men den m√• samsvare med en av de konfigurerte omdirigeringsstiene i klientregistreringen din.
- `spec.autoLogin.scopes` spesifiserer hvilke scopes som skal brukes i under _Authorization Code Flow_. I dette eksempelet er det spesifisert som `<CLIENT ID>/.default`, som er et scope Microsoft Entra ID tilbyr som implisitt inneholder alle tilgjengelige scopes for klientregistreringen.

:::warning
Ztoperator-`AuthPolicy` benytter seg av cookies for √• lagre innlogget sesjon i nettleseren. [OIDC Single Logout (SLO)](https://docs.digdir.no/docs/idporten/oidc/oidc_func_sso.html#single-logout-slo) benytter seg av `iframe` for √• logge brukeren ut av alle nettstedene som brukeren har en aktiv SSO-sesjon hos. Ettersom cookies som Ztoperator-`AuthPolicy` setter er HTTP-only s√• vil de ikke kunne aksesseres i en `iframe`, og SLO er derfor ikke st√∏ttet av Ztoperator-`AuthPolicy`.
:::

### `spec.oAuthCredentials`

`spec.oAuthCredentials` spesifiserer hvilken klient-ID og klient-hemmelighet som skal brukes under innlogging av brukere.
- `spec.oAuthCredentials.secretRef` spesifiserer hvilken Kubernetes-hemmelighet som har hemmelightene.
- `spec.oAuthCredentials.clientIDKey` spesifiserer hvilken data-n√∏kkel i Kuberenetes-hemmeligheten som har klient-IDen.
- `spec.oAuthCredentials.clientSecretKey` spesifiserer hvilken data-n√∏kkel i Kuberenetes-hemmeligheten som har klient-hemmeligheten.

### `spec.outputClaimToHeaders`

`spec.outputClaimToHeaders` spesifiserer hvilke claims i `access_token` som skal sendes som HTTP-headers til applikasjonen.

## üëÄ Lett √• overse

Selv om Ztoperator-`AuthPolicy` skal gj√∏re det lettere √• sikre appllikasjonen sin med OAuth 2.0 og OIDC, s√• er det fortsatt enkelte ting man lett kan overse.

### Audience-begrensing i ID-porten og Maksinporten

[B√•de ID-porten og Maksinporten benytter seg av audience-begrensing](https://docs.digdir.no/docs/idporten/oidc/oidc_func_aud.html), en mekanisme basert p√• [RFC 8707 Resource Indicators for Oauth2](https://tools.ietf.org/html/rfc8707), som motvirker at tokens kan misbrukes mot andre APIer enn de som er tiltenkt. En konsekvens av dette er at det er klienten sitt ansvar √• be om et audience-begrenset token. Dette er st√∏ttet i Ztoperator-`AuthPolicy` med feltet `spec.acceptedResources`. Dette feltet spesifiserer hvilke APIer tokenet skal kunne brukes mot.

### Client authentication

Per n√• st√∏tter Ztoperator kun √• autentisere klienter ved bruk av `client_secret_post`. Selve klient-autentiseringen gj√∏res av Ztoperator, men det er viktig at det er konfigurert i klientregistreringen mot identitetstilbyderen at man bruker `client_secret_post`.

:::caution
[Klientregistrering med Digdirator](../klientregistrering#-digdirator) antar at klienten _kun_ benytter seg av `private_key_jwt` som klient-autentiseringsmetode, noe som gj√∏r at klientintegrasjoner satt opp med Digdirator per n√• ikke er kompatibelt med Ztoperator-`AuthPolicy`.
:::
