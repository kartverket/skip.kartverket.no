import Admonition from '@theme/Admonition';

# Test din Ztoperator-`AuthPolicy`

Ztoperator f√∏lger en deklarativ tiln√¶rming, der tilgangsstyringen flyttes ut av applikasjonskoden og inn i teamets infrastrukturkode (IaC) ‚Äì typisk i et [apps-repo](../../09-argo-cd/02-hva-er-et-apps-repo.md).
Denne tiln√¶rmingen gir mange fordeler, men kan gj√∏re det mer utfordrende √• teste tilgangsstyringen i integrasjonstester.
For √• h√•ndtere dette kan du bruke GitHub Actionen [`test-authpolicy-action`](https://github.com/kartverket/test-authpolicy-action),
som lar deg verifisere at en `AuthPolicy` du har definert for √• styre tilgangen til applikasjonen faktisk fungerer som forventet.

## üìñ Eksempel

For √• illustrere hvordan `test-authpolicy-action` fungerer, ser vi p√• et konkret eksempel.

### üîê `AuthPolicy`

F√∏lgende `AuthPolicy` tillater uautentiserte foresp√∏rsler til URL-stien `/public` og alle under-stier.
Samtidig sikrer den at kun autentiserte foresp√∏rsler med claimet `role: admin` f√•r tilgang til `/admin` og alle under-stier.
Alle andre foresp√∏rsler som ikke omfattes av `ignoreAuthRules` eller `authRules` m√• v√¶re autentisert.

```yaml
apiVersion: ztoperator.kartverket.no/v1alpha1
kind: AuthPolicy
metadata:
  name: auth-policy
spec:
  enabled: true
  ignoreAuthRules:
    - paths:
        - /public{**}
  authRules:
    - paths:
        - /admin{**}
      when:
        - claim: role
          values:
            - admin
      denyRedirect: true
  allowedAudiences:
    - value: some-audience
  oAuthCredentials:
    secretRef: oauth-secret
    clientIDKey: CLIENT_ID_KEY
    clientSecretKey: CLIENT_SECRET_SECRET
  autoLogin:
    enabled: true
    loginPath: /login
    logoutPath: /logout
    redirectPath: /oauth2/callback
    scopes:
      - offline_access
      - openid
  wellKnownURI: https://login.microsoftonline.com/7f74c8a2-43ce-46b2-b0e8-b6306cba73a3/v2.0/.well-known/openid-configuration
  selector:
    matchLabels:
      app: application
```

### üöÄ `test-authpolicy-action`

Du kan teste nevnte `AuthPolicy` direkte i repoet der den er definert (typisk et [apps-repo](../../09-argo-cd/02-hva-er-et-apps-repo.md)) ved √• inkludere den i en GitHub Workflow-jobb.
F√∏r `test-authpolicy-action` kj√∏res, **m√•** [`setup-skip-action`](https://github.com/kartverket/setup-skip-action) v√¶re kj√∏rt for √• sette opp det n√∏dvendige milj√∏et som kreves for √• gjennomf√∏re testene.

```yaml
name: Test AuthPolicy
runs-on: ubuntu-latest
steps:
  - name: Checkout repo
    uses: actions/checkout@v3
# diff-add-start

  # üö® M√• kj√∏res f√∏rst üö®
  - name: Setup SKIP
    uses: kartverket/setup-skip-action@v0.0.3

  - name: Test AuthPolicy
    uses: kartverket/test-authpolicy-action@v0.0.2
    with:
      test: test.yaml
      authpolicy: authpolicy.yaml
# diff-add-end
```

### üß™ Test-fil

`test-authpolicy-action` har to input: filstien til `AuthPolicy`-ressursen som skal testes, og filstien til en _testfil_ som beskriver selve testene.
Testfilen m√• f√∏lge JSON-skjemaet definert [her](https://kartverket.github.io/test-authpolicy-action/v0.0.1/schema.json).

Testfilen best√•r av et navn (`name`) og en samling foresp√∏rsler (`requests`). Hver foresp√∏rsel definerer:
- √ân eller flere URL-stier.
- √ân eller flere HTTP-metoder.
- En forventet respons (`expected_response`).

I tillegg kan du angi det boolske feltet `auth` for at foresp√∏rselen skal autentiseres, dvs. at en gyldig JWT legges ved i headeren `Authorization: Bearer <JWT>`.
Du kan ogs√• oppgi en liste med `claims` som skal inkluderes i JWT-en.

F√∏lgende er et eksempel p√• en test-fil som kan brukes til √• teste `AuthPolicy`-ressursen ovenfor. Test-filen vil oversettes til HTTP-foresp√∏rsler i en [hurl-fil](https://hurl.dev/),
og en [hurl-test](https://hurl.dev/docs/running-tests.html) blir kj√∏rt og evaluerer foresp√∏rslene.

<Admonition type="tip" title="Visste du at...">
    Hvis `test-authpolicy-action` kj√∏res i en pull request s√• vil den legge ved resultatet av hurl-testen som en kommentar. Den vil der vise hurl-testen som ble opprettet p√•
    bakgrunn av test-filen. Hvis testen feiler vil den i tillegg vise hvilken HTTP-foresp√∏rsel i hurl-filen som feilet, og peke p√• hvilken foresp√∏rsel i testen denne stammer fra.
</Admonition>

```yaml
name: Test AuthPolicy
requests:
  # Verifiser at stien /public og alle under-stier er √•pne
  - paths:
      - /public
      - /public123
    expected_response: allowed

  # Verifiser at stien /admin og alle under-stier blir blokkert uten gyldig JWT
  - paths:
      - /admin
      - /admin123
    expected_response: denied

  # Verifiser at stien /admin og alle under-stier ikke slipper gjennom med kun autentisert JWT (krever ogs√• claimet role: admin)
  - paths:
      - /admin
      - /admin123
    auth: true
    expected_response: denied

  # Verifiser at stien /admin og alle under-stier er √•pne n√•r autentisert JWT med claimet role: admin legges ved
  - paths:
      - /admin
      - /admin123
    auth: true
    claims:
      - claim: role
        values:
          - admin
    expected_response: allowed

  # Verifiser at stier som ikke er nevnt i AuthPolicy-ressursen ikke er √•pne og omdirigerer til innlogging
  - paths:
      - /something
    expected_response: login_redirect

  # Verifiser at stier som ikke er nevnt i AuthPolicy-ressursen krever autentisert JWT
  - paths:
      - /something
    auth: true
    expected_response: allowed
```
