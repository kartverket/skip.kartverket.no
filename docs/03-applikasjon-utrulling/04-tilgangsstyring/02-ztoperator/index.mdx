import ZtoperatorLogo from '../images/ztoperator-logo.png';
import Columns from '@site/src/components/Columns';
import Column from '@site/src/components/Column';

# Ztoperator

:::danger[Deprecation warnings]
Ztoperator har aktive deprecation warnings, se [deprecation warnings](#deprecation-warnings) for mer informasjon.
- `audience` vil fjernes til fordel for `allowedAudiences`
- Bruk av wildcards `*` i `paths` vil fjernes til fordel for eksplisitt syntaks med `{*}` og `{**}`
:::

<Columns>
  <Column className='col--8'>
    Ztoperator er en Kubernetes-operator som lar deg deklarativt definere hvordan tilgang til en applikasjons endepunkter skal styres. Den gir st칮tte for 친
    
    - definere hvilke endepunkter som skal v칝re 친pne.
    - definere hvilke endepunkter som krever et gyldig OAuth 2.0-token.
    - definere hvilke endepunkter som krever spesifikke claims.
    - definere hvilke endepunkter som skal omdirigere brukeren til innlogging.
  </Column>
  <Column className='text--center'>
    <img src={ZtoperatorLogo} style={{width: 300}} />
  </Column>
</Columns>

Ztoperator konfigureres opp mot en identitetstilbyder med feltet `spec.wellKnownURI`, som peker til et [OpenID Connect Discovery Document](https://openid.net/specs/openid-connect-discovery-1_0.html). Dette dokumentet inneholder informasjon om hvordan Ztoperator skal kommunisere med identitetstilbyderen, slik som endepunkter for autentisering, tokenvalidering og utlogging. 
Hvilke identitetstilbydere Ztoperator st칮tter per n친 kan ses under [St칮ttede identitetstilbydere](#-st칮ttede-identitetstilbydere).

Hvilke felter som eksisterer og deres oppf칮rsel er dokumentert i [API Reference](02-api-docs.mdx).
Hvordan du kan teste og verifisere oppf칮rselen til en `AuthPolicy` finner du under [Test din Ztoperator-AuthPolicy](03-test-authpolicy.mdx).

## 游 Innlogging og utlogging med Ztoperator

Det g친r an 친 konfigurere Ztoperator til 친 h친ndtere innlogging og utlogging av sluttbrukere p친 vegne av applikasjonen din. 
Dette gj칮res ved 친 sette opp `spec.autoLogin` og `spec.oAuthCredentials` i Ztoperator-`AuthPolicy`-ressursen din. 
`spec.autoLogin` konfigurerer ulike endepunkter brukt i innloggings -og utloggingsflyten, mens `spec.oAuthCredentials` 
peker til en Kubernetes-hemmelighet som inneholder klient-ID `client_id` og klienthemmelighet `client_secret` for en registrert OIDC-klient hos identitetstilbyderen. 

En annen ting 친 merke seg er at Ztoperator ikke har lov til 친 laste inn hemmeligheter som brukes for innlogging i den beskyttede applikasjonen. 
For 친 l칮se dette er man n칮dt til 친 legge til en konfigurasjon p친 den beskyttede Skiperator-applikasjonen for at innloggingshemligheter som Ztoperator h친ndterer skal kunne lastes inn.
F칮lgende eksempel viser hvordan dette kan gj칮res i en Skiperator-applikasjon. Hvorfor det m친 til overlates som en oppgave til leseren, men det viktige er at 
man er n칮dt til 친 erstatte `<NAVN P칀 AUTHPOLICY>` med navnet p친 sin Ztoperator-`AuthPolicy`. S친 hvis din `AuthPolicy` heter `my-auth-policy`, s친 m친 du sette `secretName: my-auth-policy-envoy-secret`.

:::danger[OBS]
For at innlogging skal fungere med Ztoperator, **m친** den beskyttede Skiperator-applikasjonen oppdateres med 
`spec.podSettings.annotations.sidecar.istio.io/userVolume` og `spec.podSettings.annotations.sidecar.istio.io/userVolumeMount`.
:::

```yaml title="Skiperator-applikasjon med Ztoperator-innlogging"
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: myapp
spec:
//diff-add-start
  podSettings:
    annotations:
      sidecar.istio.io/userVolume: |
        [
          {
            "name": "istio-oauth2",
            "secret": {
              "secretName": "<NAVN P칀 AUTHPOLICY>-envoy-secret"
            }
          }
        ]
      sidecar.istio.io/userVolumeMount: |
        [
          {
            "name": "istio-oauth2",
            "mountPath": "/etc/istio/config",
            "readonly": true
          }
        ]
//diff-add-end
  image: ghcr.io/kartverket/myapp:latest
  port: 8080
  ingresses:
    - myapp.atkv3-dev.kartverket-intern.cloud
  redirectToHTTPS: true
  accessPolicy:
    inbound: 
      rules:
        - application: myjob-skipjob
```

## 游꿟 Tutorials

I denne docsen finner du en rekke tutorials p친 hvordan du tar i bruk Ztoperator for 친 beskytte en applikasjon p친 SKIP.

- [Eksempeloppsett av Ztoperator: Microsoft Entra ID](01-tutorials.mdx#--microsoft-entra-id)
- [Eksempeloppsett av Ztoperator: ID-Porten](01-tutorials.mdx#-id-porten)
- [Eksempeloppsett av Ztoperator: Ansattporten](01-tutorials.mdx#-ansattporten)

## 游 St칮ttede identitetstilbydere

| Milj칮 | Identitetstilbyder | `wellKnownURI` |
| --- | --- | --- |
| `PROD` | Microsoft Entra ID (Kartverket) | [https://login.microsoftonline.com/7f74c8a2-43ce-46b2-b0e8-b6306cba73a3/v2.0/.well-known/openid-configuration](https://login.microsoftonline.com/7f74c8a2-43ce-46b2-b0e8-b6306cba73a3/v2.0/.well-known/openid-configuration) |
| `TEST` | ID-porten | [https://test.idporten.no/.well-known/openid-configuration](https://test.idporten.no/.well-known/openid-configuration) |
| `PROD` | ID-porten | [https://idporten.no/.well-known/openid-configuration](https://idporten.no/.well-known/openid-configuration) |
| `TEST` | Maskinporten | [https://test.maskinporten.no/.well-known/oauth-authorization-server](https://test.maskinporten.no/.well-known/oauth-authorization-server) |
| `PROD` | Maskinporten | [https://maskinporten.no/.well-known/oauth-authorization-server](https://maskinporten.no/.well-known/oauth-authorization-server) |
| `TEST` | Ansattporten | [https://test.ansattporten.no/.well-known/openid-configuration](https://test.ansattporten.no/.well-known/openid-configuration) |
| `PROD` | Ansattporten | [https://ansattporten.no/.well-known/openid-configuration](https://ansattporten.no/.well-known/openid-configuration) |

## Deprecation warnings

### Nytt felt for audience med st칮tte for b친de statiske og dynamiske referanser
Feltet `audience` vil fjernes innen kort tid. Bruk `allowedAudiences`, med enten statisk eller dynamisk referanse:
```
kind: AuthPolicy
spec:
  allowedAudiences:
    # statisk
    - value: <AUDIENCE>
    # dynamisk via secret
    - valueFrom:
        secretKeyRef:
          name: <SECRET_NAME>
          key: <SECRET_KEY>
    # dynamisk via configmap
    - valueFrom:
        configMapKeyRef:
          name: <CONFIGMAP_NAME>
          key: <CONFIGMAP_KEY>
```

## Ny syntaks for wildcards i `paths`
St칮tte for frittst친ende wildcards `*` i `paths` vil fjernes innen kort tid. Bruk eksplisitt syntaks som enten matcher
칟n `{*}` eller flere `{**}` path-segmenter:
```
kind: AuthPolicy
spec:
  ignoreAuthRules:
    - paths:
        # vilk친rlig mange path-segmenter
        - /{**}
        # ett vilk친rlig path-segment
        - /{*}
        # komplett eksempel
        - /api/{*}/endpoint/{**}
```