import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';

# Token-validering og grovkornet autorisasjon

SKIP benytter seg av kubernetes operatoren [Ztoperator](https://github.com/kartverket/ztoperator) for √• h√•ndheve token-validering og grovkornet autorisasjon for tjenester som kj√∏rer p√• SKIP.

Hvis man √∏nsker √• benytte seg av SKIP sin l√∏sning for √• sette opp token-validering og grovkornet autorisasjon, har man to valg.
Man kan benytte seg av [Skiperator](../03-skiperator/index.md) dersom man √∏nsker √• holde konfigurasjonen n√¶r Skiperator-manifestet.
Alternativt kan man bruke CRD-en fra Ztoperator direkte.

Felles for begge alternativene er at de bygger inn to prinsipper i hvordan token-validering og grovkornet autorisasjon settes opp.
- **Gyldig JWT by default**: Med mindre endepunkt er eksplisitt spesifisert som √•pne _m√•_
innkommende request ha en gyldig JWT.
- **Trygge standardinnstillinger**: Hvis man ved en feil spesifiserer et endepunkt som b√•de √•pent og autorisert, vil foresp√∏rselen som standard kreve et gyldig og autorisert JWT.

<Tabs groupId={"operator"}>
    <TabItem value="ztoperator" label="Ztoperator">
        Ztoperator introduserer CRD-en `AuthPolicy`, som har i oppgave √• sette opp token-validering og grovkornet autorisasjon.
        `AuthPolicy` har som hovedoppgave √• opprette Istio-ressursene `RequestAuthentication` og `AuthorizationPolicy`
        p√• en m√•te som f√∏lger brukerens definerte *regler*, samtidig som de to prinsippene nevnt ovenfor ivaretas. API-dokumentasjonen til Ztoperator finner
        du [her](04-ztoperator/02-api-docs.mdx). Hvordan du tester og verifiserer at en `AuthPolicy` fungerer som forventet kan du lese mer om [her](04-ztoperator/01-test-authpolicy.mdx).

        Hvilken workload reglene definert i en `AuthPolicy` skal gjelde for spesifiseres ved √• referere til *labels*.

        <Admonition type="tip" title="Visste du at...">
          Hvis du har en Skiperator-applikasjon med navn `some-application` vil den f√• labelen `app: some-application`.
        </Admonition>

        ## üß† Wildcards for URL-stier (_paths_)
        N√•r man setter opp tilgangsstyring med Ztoperator, s√• kan man enten √•pne opp tilgang til endepunkter, eller spesifisere endepunkter som
        skal v√¶re autentiserte og/eller grovkornet autoriserte (innsnevre tilgang til endepunkt basert p√• verdiene til token-`claims`). Da spesifiserer man et sett med en eller flere URL-stier.
        Istio, og dermed ogs√• Ztoperator, st√∏tter bruken av **wildcards** i disse stiene, men er noe uklar i bruken av disse i deres dokumentasjon.

        Ztoperator st√∏tter bruken av _tre_ wildcard-operatorer: `*`, `{*}` og `{**}`, **der `*` er den _gamle_ wildcard-syntaksen, mens `{*}` og `{**}` er den _nye_ wildcard-syntaksen**.
        Ztoperator har f√∏lgende validering av stier:

        - En sti kan **ikke blande** gammel og ny wildcard-syntax.
        - Wildcardet `*`, (dvs. gammel wildcard-syntaks), kan **kun** brukes som enten prefiks, suffiks eller alene. Wildcardet vil da **matche null eller flere sti-segmenter (deler av stien mellom `/`)**.
        - Wildcardet `{*}`, (dvs. ny wildcard-syntaks), kan **kun brukes alene** i et sti-segment. Wildcardet vil da **matche ett sti-segment (deler av stien mellom `/`)**.
        - Wildcardet `{**}`, (dvs. ny wildcard-syntaks), kan **kun brukes alene** i et sti-segment. Wildcardet vil da **matche null _eller_ flere sti-segmenter (deler av stien mellom `/`)**. Hvis `{**}` benyttes s√• **m√•** den v√¶re den siste wilcard-operatoren.

        ### üìë Eksempler p√• wildcards for URL-stier

        | Sti              | Gyldig | Forklaring                                                             |
        |-------------------|---------|-------------------------------------------------------------------------|
        | `*` | ‚úÖ | Matcher alle stier |
        | `*/foo/bar`| ‚úÖ | Matcher `/foo/bar`, `/api/foo/bar`, `/api/something/foo/bar`, `/api/something/else/foo/bar`. |
        | `/foo/bar*` | ‚úÖ | Matcher `/foo/bar`, `/foo/bar/baz`, `/foo/bar/baz.html`. |
        | `/foo/{*}/` | ‚úÖ | Matcher `/foo/bar`, men _ikke_ `/foo/bar/baz`. |
        | `/foo/{**}/` | ‚úÖ | Matcher `/foo/bar/`, `/foo/bar/baz.txt`, og `/foo//`, men ikke `/foo/bar`. |
        | `/foo/{*}/bar/{**}` | ‚úÖ | Matcher `/foo/buzz/bar/` og `/foo/buzz/bar/baz`. |
        | `foo/*/bar` | ‚ùå | Kun lov √• bruke wildcardet `*` som enten prefiks, suffiks eller alene. |
        | `/*/baz/{*}` | ‚ùå | Ikke lov √• blande gammel og ny wildcard-syntaks. |
        | `/**/baz/{*}` | ‚ùå | Wildcard-operatoren `**` er ikke lov √• bruke, den m√• v√¶re omsluttet av kr√∏llparenteser, i.e. `{**}`. |
        | `/{**}/foo/{*}` | ‚ùå | Ikke lov: Hvis wildcard-operatoren `{**}` benyttes **m√•** den v√¶re den siste wildcard-operatoren. |
        | `/foo/{*}.txt` | ‚ùå | Wildcard-operatoren `{*}` er ikke lov √• bruke sammen med andre tegn innenfor et sti-segment. |
    </TabItem>
    <TabItem value="skiperator" label="Skiperator">
        üöß **UNDER UTVIKLING** üöß<br />
        St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
    </TabItem>
</Tabs>

## üìñ Eksempler

Under f√∏lger en rekke eksempler p√• hvordan √• konfigurere token-validering og grovkornet autorisasjon p√• SKIP.

<details>
  <summary><strong>Eksempel 1: Token-validering for _alle_ endepunkt</strong></summary>

    <Tabs groupId={"operator"}>
        <TabItem value="ztoperator" label="Ztoperator">
            F√∏lgende `AuthPolicy`-manifest konfigurerer token-validering for alle endepunktene inn til workloads med labelen `app: some-application` i namespacet `some-namespace`.

            ```yaml
            apiVersion: ztoperator.kartverket.no/v1alpha1
            kind: AuthPolicy
            metadata:
              name: some-auth-policy
              namespace: some-namespace
            spec:
              enabled: true
              audience:
                - some-audience
              wellKnownURI: https://some-issuer.com/.well-known/openid-configuration
              selector:
                matchLabels:
                  app: some-application
            ```
        </TabItem>
        <TabItem value="skiperator" label="Skiperator">
            üöß **UNDER UTVIKLING** üöß<br />
            St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
        </TabItem>
    </Tabs>
</details>

<details>
  <summary><strong>Eksempel 2: Legg til √•pne endepunkt</strong></summary>

  <Tabs groupId={"operator"}>
          <TabItem value="ztoperator" label="Ztoperator">
            F√∏lgende `AuthPolicy`-manifest konfigurerer token-validering for alle endepunktene inn til `some-application`, **utenom** for `GET` til `/api/cars` og `/api/cars/public*`.

            <Admonition type="warning" title="Legg merke til...">
                Her er wildcard (`*`) brukt. Resultatet blir da at `GET` mot `/api/cars`, `/api/cars/public` og alle andre sub-paths av `/api/cars/public` vil v√¶re √•pne,
                mens requests mot andre stier vil kreve autentisert JWT, dvs. JWT med claimet `iss: https://some-issuer.com` og `aud: some-audience`.
            </Admonition>

          ```yaml
          apiVersion: ztoperator.kartverket.no/v1alpha1
          kind: AuthPolicy
          metadata:
            name: some-auth-policy
            namespace: some-namespace
          spec:
            enabled: true
            audience:
              - some-audience
            wellKnownURI: https://some-issuer.com/.well-known/openid-configuration
            ignoreAuthRules:
              - paths:
                  - "/api/cars"
                  - "/api/cars/public*"
                methods:
                  - "GET"
            selector:
              matchLabels:
                app: some-application
          ```

        </TabItem>
          <TabItem value="skiperator" label="Skiperator">
              üöß **UNDER UTVIKLING** üöß<br />
              St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
          </TabItem>
  </Tabs>

</details>


<details>
  <summary><strong>Eksempel 3: Legg til autoriserte endepunkt</strong></summary>

      <Tabs groupId={"operator"}>
              <TabItem value="ztoperator" label="Ztoperator">
                F√∏lgende `AuthPolicy`-manifest konfigurerer token-validering for alle endepunktene inn til `some-application`, **utenom** for endepunktene `/api/cars*` og `/api/cars/public` **for alle metoder**.
                I tillegg spesifiserer den at `POST`, `PUT` og `DELETE` mot `/api/cars/admin` kun er lov hvis JWT-claimet `roles` eksisterer med verdien `admin`.

                <Admonition type="warning" title="Legg merke til...">
                  Stiene `/api/cars` og alle sub-stier er n√• spesifisert som √•pne, som **er i konflikt** med at `POST`, `PUT` og `DELETE` mot `/api/cars/admin`
                  krever autorisert JWT (`roles: admin`). Her spiller prinsippet om **trygge standardinnstillinger** inn, og Ztoperator vil falle tilbake til √• kreve autorisert
                  JWT for `POST`, `PUT` og `DELETE` mot `/api/cars/admin`.
                </Admonition>

          ```yaml
          apiVersion: ztoperator.kartverket.no/v1alpha1
          kind: AuthPolicy
          metadata:
            name: some-auth-policy
            namespace: some-namespace
          spec:
            enabled: true
            audience:
              - some-audience
            wellKnownURI: https://some-issuer.com/.well-known/openid-configuration
            ignoreAuthRules:
              - paths:
                  - "/api/cars*"
                  - "/api/cars/public"
            authRules:
              - paths:
                  - "/api/cars/admin"
                methods:
                  - POST
                  - PUT
                  - DELETE
                when:
                  - claim: "roles"
                    values:
                      - "admin"
            selector:
              matchLabels:
                app: some-application
          ```

            </TabItem>
              <TabItem value="skiperator" label="Skiperator">
                  üöß **UNDER UTVIKLING** üöß<br />
                  St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
              </TabItem>
      </Tabs>
</details>
