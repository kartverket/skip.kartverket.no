import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import Admonition from '@theme/Admonition';

# üõ°Ô∏è Token-validering og grovkornet autorisasjon

SKIP tilbyr innebygd st√∏tte for √• sette opp Kubernetes-ressurser som kan validere autentisiteten og autorisasjonen p√•
inkommende requests f√∏r den i det hele tatt n√•r applikasjonen. Dette er mulig fordi SKIP benytter seg av [Istio](https://istio.io/) som service mesh
og instruerer Istio til √• sette opp en [Istio-sidecar](https://istio.io/latest/docs/reference/config/networking/sidecar/)
i hver `pod`.

Fordelen med at hver `pod` har en `istio-sidecar` er at Istio introduserer flere nyttige CRD-er som kan berike kapabilitetene
til `istio-sidecar`. To av disse CRD-ene er [`RequestAuthentication`](https://istio.io/latest/docs/reference/config/security/request_authentication/)
og [`AuthorizationPolicy`](https://istio.io/latest/docs/reference/config/security/authorization-policy/), som blant annet kan brukes til √• validere tokens (JWT) til innkommende requests og autorisere tilgang basert p√• claims.

![Istio Sidecar Container Architecture](images/istio-sidecar.png)
*Kilde: [Kube by Example](https://kubebyexample.com/learning-paths/istio/intro)*

SKIP benytter seg av kubernetes operatoren [Ztoperator](https://github.com/kartverket/ztoperator) for √• h√•ndheve token-validering og grovkornet autorisasjon for tjenester som kj√∏rer p√• SKIP.

Hvis man √∏nsker √• benytte seg av SKIP sin l√∏sning for √• sette opp token-validering og grovkornet autorisasjon, har man to valg.
Man kan benytte seg av [Skiperator](../03-skiperator/index.md) dersom man √∏nsker √• holde konfigurasjonen n√¶r Skiperator-manifestet.
Alternativt kan man bruke CRD-en fra [Ztoperator](https://github.com/kartverket/ztoperator) direkte.

Felles for begge alternativene er at de bygger inn to prinsipper i hvordan token-validering og grovkornet autorisasjon settes opp.
- **Gyldig JWT by default**: Med mindre endepunkt er eksplisitt spesifisert som √•pne _m√•_
innkommende request ha en gyldig JWT.
- **Trygge standardinnstillinger**: Hvis man ved en feil spesifiserer et endepunkt som b√•de √•pent og autorisert, vil foresp√∏rselen som standard kreve et gyldig og autorisert JWT.

<Tabs groupId={"operator"}>
    <TabItem value="skiperator" label="Skiperator">
        üöß **UNDER UTVIKLING** üöß<br />
        St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
    </TabItem>
    <TabItem value="ztoperator" label="Ztoperator">
        Ztoperator introduserer CRD-en `AuthPolicy`, som har i oppgave √• sette opp token-validering og grovkornet autorisasjon.
        `AuthPolicy` har som hovedoppgave √• opprette Istio-ressursene `RequestAuthentication` og `AuthorizationPolicy`
        p√• en m√•te som f√∏lger brukerens definerte *regler*, samtidig som de to prinsippene nevnt ovenfor ivaretas.

        Hvilken workload reglene definert i en `AuthPolicy` skal gjelde for spesifiseres ved √• referere til *labels*.

        <Admonition type="tip" title="Visste du at...">
          Hvis du har en Skiperator-applikasjon med navn `some-application` vil den f√• labelen `app: some-application`.
        </Admonition>

        ## üßæSpesifikasjonen til `AuthPolicy`

        <details>
          <summary><strong>spec</strong> _(object, required)_ ‚Äì Spesifikasjon for `AuthPolicy`</summary>

            <p><strong>enabled</strong> _(boolean, required)_ ‚Äì Angir om JWT-validering skal v√¶re aktivert. Hvis aktivert, vil innkommende JWT-er bli validert mot spesifisert utsteder og audience.</p>
            <p><strong>issuerURI</strong> _(string, required)_ ‚Äì Forventet `iss`-claim i JWT. M√• samsvare med den som ble brukt da tokenet ble utstedt.</p>
            <p><strong>jwksURI</strong> _(string, required)_ ‚Äì URI for √• hente JWKS (n√∏kkelsett brukt til √• verifisere JWT-signatur).</p>
            <p><strong>audience</strong> _([]string, required)_ ‚Äì Liste med aksepterte `aud`-verdier i JWT. Minst √©n verdi m√• finnes i tokenet for at det skal v√¶re gyldig.</p>
            <p><strong>forwardJwt</strong> _(boolean, optional)_ ‚Äì Hvis satt til `true`, videresendes den originale JWT-en. Standard er `true`.</p>
            <p><strong>fromCookies</strong> _([]string, optional)_ ‚Äì Lister hvilke cookies som skal unders√∏kes for JWT.</p>

            <details>
                <summary><strong>outputClaimToHeaders</strong> _([]object, optional)_ ‚Äì Definerer hvordan claims fra verifisert JWT skal kopieres til HTTP-headere. St√∏tter enkle og n√∏stede verdier av typen `string`, `int` eller `bool.</summary>
                <p><strong>claim</strong> _(string, required)_ ‚Äì Navn p√• claimet som skal hentes fra JWT.</p>
                <p><strong>header</strong> _(string, required)_ ‚Äì Navn p√• HTTP-headeren som skal inneholde claim-verdien.</p>
            </details>

            <p><strong>acceptedResources</strong> _([]string, optional)_ ‚Äì Liste med ressursindikatorer som m√• finnes i JWT (`aud`). F√∏lger <a href="https://datatracker.ietf.org/doc/html/rfc8707" target="_blank" rel="noopener noreferrer">RFC8707</a>. M√• v√¶re gyldige URI-er.</p>

            <details>
                <summary><strong>authRules</strong> _([]object, optional)_ ‚Äì Regler for √• tillate HTTP-foresp√∏rsler basert p√• p√•stander i JWT.</summary>
                <p><strong>paths</strong> _([]string, required)_ ‚Äì Stier regelen skal gjelde for. M√• starte med `/`, ikke slutte med `/`, og kan avsluttes med `*` som wildcard-operator.</p>
                <p><strong>methods</strong> _([]string, optional)_ ‚Äì HTTP-metoder som regelen gjelder for. Hvis ikke angitt, tillates alle metoder. Tillatte metoder er `GET`, `POST`, `PUT`, `PATCH`, `DELETE`, `HEAD`, `OPTIONS`, `TRACE`, `CONNECT`.</p>

                <details>
                    <summary><strong>when</strong> _([]object, required)_ ‚Äì Tilleggskrav basert p√• JWT-claims. Foresp√∏rselen tillates hvis minst ett av tilleggskravene er oppfylt.</summary>
                    <p><strong>claim</strong> _(string, required)_ ‚Äì Navnet p√• JWT-claimet som skal kontrolleres.</p>
                    <p><strong>values</strong> _([]string, required)_ ‚Äì Verdier som claimet m√• inneholde for √• v√¶re gyldig. Tilleggskravet er m√∏tt hvis claimet fra JWT inneholder √©n eller flere av disse verdiene (OR-logikk).</p>
                </details>
            </details>

            <details>
                <summary><strong>ignoreAuthRules</strong> _([]object, optional)_ ‚Äì Definerer hvilke foresp√∏rsler som ikke krever JWT-autentisering.</summary>
                <p><strong>paths</strong> _([]string, required)_ ‚Äì Stier regelen skal gjelde for. M√• starte med `/`, ikke slutte med `/`, og kan avsluttes med `*` som wildcard-operator.</p>
                <p><strong>methods</strong> _([]string, optional)_ ‚Äì HTTP-metoder som regelen gjelder for. Hvis ikke angitt, tillates alle metoder. Tillatte metoder er `GET`, `POST`, `PUT`, `PATCH`, `DELETE`, `HEAD`, `OPTIONS`, `TRACE`, `CONNECT`.</p>
            </details>

          <details>
            <summary><strong>selector</strong> _(object, required)_ ‚Äì Bestemmer hvilke workloads policyen skal gjelde for.</summary>
            <p><strong>matchLabels</strong> _(map[string]string, optional)_ ‚Äì Et sett med labels som brukes til √• identifisere hvilke workloads policyen skal gjelde for. Gjelder bare innenfor samme namespace. Label-n√∏kler kan ikke v√¶re tomme eller inneholde wildcard-tegn.</p>
          </details>
        </details>

        ## üß† Wildcards for URL-stier (_paths_)
        N√•r man setter opp tilgangsstyring med Ztoperator, s√• kan man enten √•pne opp tilgang eller autorisere tilgang mot endepunkter. Da spesifiserer man et sett med en eller flere URL-stier.
        Istio, og dermed ogs√• Ztoperator, st√∏tter bruken av **wildcards** i disse stiene, men er noe uklar i bruken av disse i deres dokumentasjon.

        Ztoperator st√∏tter bruken av _tre_ wildcard-operatorer: `*`, `{*}` og `{**}`, **der `*` er den _gamle_ wildcard-syntaksen, mens `{*}` og `{**}` er den _nye_ wildcard-syntaksen**.
        Ztoperator har f√∏lgende validering av stier:

        - En sti kan **ikke blande** gammel og ny wildcard-syntax.
        - Wildcardet `*`, (dvs. gammel wildcard-syntaks), kan **kun** brukes som enten prefiks, suffiks eller alene. Wildcardet vil da **matche null eller flere sti-segmenter (deler av stien mellom `/`)**.
        - Wildcardet `{*}`, (dvs. ny wildcard-syntaks), kan **kun brukes alene** i et sti-segment. Wildcardet vil da **matche ett sti-segment (deler av stien mellom `/`)**.
        - Wildcardet `{**}`, (dvs. ny wildcard-syntaks), kan **kun brukes alene** i et sti-segment. Wildcardet vil da **matche null _eller_ flere sti-segmenter (deler av stien mellom `/`)**. Hvis `{**}` benyttes s√• **m√•** den v√¶re den siste wilcard-operatoren.

        ### üìë Eksempler p√• wildcards for URL-stier

        | Sti              | Gyldig | Forklaring                                                             |
        |-------------------|---------|-------------------------------------------------------------------------|
        | `*` | ‚úÖ | Matcher alle stier|
        | `*/foo/bar`| ‚úÖ | Matcher `/foo/bar`, `/api/foo/bar`, `/api/something/foo/bar`, `/api/something/else/foo/bar` |
        | `/foo/bar*` | ‚úÖ | Matcher `/foo/bar`, `/foo/bar/baz`, `/foo/bar/baz.html` |
        | `/foo/{*}/` | ‚úÖ | Matcher `/foo/bar`, men _ikke_ `/foo/bar/baz`. |
        | `/foo/{**}/` | ‚úÖ | Matcher `/foo/bar/`, `/foo/bar/baz.txt`, og `/foo//`, men ikke `/foo/bar`. |
        | `/foo/{*}/bar/{**}` | ‚úÖ | Matcher `/foo/buzz/bar/` og `/foo/buzz/bar/baz`. |
        | `foo/*/bar` | ‚ùå | Kun lov √• bruke wildcardet `*` som enten prefiks, suffiks eller alene |
        | `/*/baz/{*}` | ‚ùå | Ikke lov √• blande gammel og ny wildcard-syntaks. |
        | `/**/baz/{*}` | ‚ùå | Wildcard-operatoren `**` er ikke lov √• bruke, men m√• v√¶re omsluttet av kr√∏llparenteser, i.e. `{**}` |
        | `/{**}/foo/{*}` | ‚ùå | Ikke lov |
        | `/foo/{*}.txt` | ‚ùå | is invalid since there are characters other than `{*}` in the path segment |
    </TabItem>
</Tabs>

## üìñ Eksempler

Under f√∏lger en rekke eksempler p√• hvordan √• konfigurere token-validering og grovkornet autorisasjon p√• SKIP.

<details>
  <summary><strong>Eksempel 1: Token-validering for _alle_ endepunkt</strong></summary>

    <Tabs groupId={"operator"}>
        <TabItem value="skiperator" label="Skiperator">
            üöß **UNDER UTVIKLING** üöß<br />
            St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
        </TabItem>
        <TabItem value="ztoperator" label="Ztoperator">
            F√∏lgende `AuthPolicy`-manifest konfigurerer token-validering for alle endepunktene inn til workloads med labelen `app: some-application` i namespacet `some-namespace`.

            ```yaml
            apiVersion: ztoperator.kartverket.no/v1alpha1
            kind: AuthPolicy
            metadata:
              name: some-auth-policy
              namespace: some-namespace
            spec:
              enabled: true
              audience:
                - some-audience
              issuerURI: https://some-issuer.com
              jwksURI: https://some-jwks-uri.com
              selector:
                matchLabels:
                  app: some-application
            ```
        </TabItem>
    </Tabs>
</details>

<details>
  <summary><strong>Eksempel 2: Legg til √•pne endepunkt</strong></summary>

  <Tabs groupId={"operator"}>
          <TabItem value="skiperator" label="Skiperator">
              üöß **UNDER UTVIKLING** üöß<br />
              St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
          </TabItem>
          <TabItem value="ztoperator" label="Ztoperator">
            F√∏lgende `AuthPolicy`-manifest konfigurerer token-validering for alle endepunktene inn til `some-application`, **utenom** for `GET` til `/api/cars` og `/api/cars/public*`.

            <Admonition type="warning" title="Legg merke til...">
                Her er wildcard (`*`) brukt. Resultatet blir da at `GET` mot `/api/cars`, `/api/cars/public` og alle andre sub-paths av `/api/cars/public` vil v√¶re √•pne,
                mens requests mot andre stier vil kreve autentisert JWT, dvs. JWT med claimet `iss: https://some-issuer.com` og `aud: some-audience`.
            </Admonition>


          ```yaml
          apiVersion: ztoperator.kartverket.no/v1alpha1
          kind: AuthPolicy
          metadata:
            name: some-auth-policy
            namespace: some-namespace
          spec:
            rules:
              - enabled: true
                audience:
                  - some-audience
                issuerURI: https://some-issuer.com
                jwksURI: https://some-jwks-uri.com
                ignoreAuthRules:
                  - paths:
                      - "/api/cars"
                      - "/api/cars/public*"
                    methods:
                      - "GET"
            selector:
              matchLabels:
                app: some-application
          ```
        </TabItem>
  </Tabs>

</details>


<details>
  <summary><strong>Eksempel 3: Legg til autoriserte endepunkt</strong></summary>

      <Tabs groupId={"operator"}>
              <TabItem value="skiperator" label="Skiperator">
                  üöß **UNDER UTVIKLING** üöß<br />
                  St√∏tte for √• sette opp token-validering og grovkornet autorisasjon via Skiperator-manifestet er under utvikling og er forel√∏pig ikke tilgjengelig.
              </TabItem>
              <TabItem value="ztoperator" label="Ztoperator">
                F√∏lgende `AuthPolicy`-manifest konfigurerer token-validering for alle endepunktene inn til `some-application`, **utenom** for endepunktene `/api/cars*` og `/api/cars/public` **for alle metoder**.
                I tillegg spesifiserer den at `POST`, `PUT` og `DELETE` mot `/api/cars/admin` kun er lov hvis JWT-claimet `roles` eksisterer med verdien `admin`.

          ```yaml
          apiVersion: ztoperator.kartverket.no/v1alpha1
          kind: AuthPolicy
          metadata:
            name: some-auth-policy
            namespace: some-namespace
          spec:
            rules:
              - enabled: true
                audience:
                  - some-audience
                issuerURI: https://some-issuer.com
                jwksURI: https://some-jwks-uri.com
                ignoreAuthRules:
                  - paths:
                      - "/api/cars*"
                      - "/api/cars/public"
                authRules:
                  - paths:
                      - "/api/cars/admin"
                    methods:
                      - POST
                      - PUT
                      - DELETE
                    when:
                      - claim: "roles"
                        values:
                          - "admin"
            selector:
              matchLabels:
                app: some-application
          ```

                <Admonition type="warning" title="Legg merke til...">
                  Stiene `/api/cars` og alle sub-stier er n√• spesifisert som √•pne, som **er i konflikt** med at `POST`, `PUT` og `DELETE` mot `/api/cars/admin`
                  krever autorisert JWT (`roles: admin`). Her spiller prinsippet om **trygge standardinnstillinger** inn, og Ztoperator vil falle tilbake til √• kreve autorisert
                  JWT for `POST`, `PUT` og `DELETE` mot `/api/cars/admin`.
                </Admonition>

            </TabItem>
      </Tabs>
</details>

