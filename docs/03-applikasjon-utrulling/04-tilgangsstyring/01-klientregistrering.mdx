import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# ğŸ“ Klientregistrering

Klientregistrering er en sentral del av tilgangsstyring med OAuth 2.0 og OIDC. NÃ¥r du registrerer en klient, fÃ¥r applikasjonen sin egen identitet og kan autentisere seg mot de valgte identitetstilbyderne.

Vi anbefaler Ã¥ ha et bevisst forhold til hvilke tjenester som skal dele samme `audience`.
Det er ofte mer hensiktsmessig Ã¥ velge en restriktiv tilnÃ¦rming, der hver tjeneste fÃ¥r sin egen klientregistrering, fremfor Ã¥ gruppere flere tjenester under Ã©n felles klient. Dette gir bedre kontroll over tilgangsstyring og sikkerhet.

Felles for alle identitetstilbydere pÃ¥ SKIP er at klientregistrering stÃ¸ttes fra plattformen ved hjelp av Kubernetes-operatorer.

- [**Digdirator**](https://github.com/nais/digdirator) hÃ¥ndterer klientregistrering mot Digdir sine felleslÃ¸sninger, nemlig **ID-porten** og **Maskinporten**.
- [**Azurerator**](https://github.com/nais/azurerator) tar seg av klientregistrering mot **Microsoft Entra ID** (tidligere kjent som Azure Active Directory).



<Tabs>
    <TabItem value="skiperator" label="Skiperator">

        CRD-en `Application` definert i Skiperator tilbyr et forenklet API for Ã¥ registrere klienter mot **ID-porten** og **Maskinporten**.
        Vi jobber ogsÃ¥ med Ã¥ innfÃ¸re tilsvarende funksjonalitet for **Entra ID**, men det er ikke helt klart ennÃ¥.

        <Tabs>
            <TabItem value="entraid" label="Entra ID">
                ## ğŸš§ Under utvikling ğŸš§

                Automatisert klientregistrering mot Entra ID i SKiperator application-manifestet er for tiden under utvikling og er ikke helt klart ennÃ¥.
                Vi jobber hardt for Ã¥ gjÃ¸re det tilgjengelig, og vi gleder oss til Ã¥ vise deg hvordan du kan ta den i bruk sÃ¥ snart vi er klare!
                FÃ¸lg med for oppdateringer.
            </TabItem>
            <TabItem value="idporten" label="ID-porten">
                [Skiperator](../03-skiperator/04-api-docs.md) tilbyr stÃ¸tte for Ã¥ sette opp en klientintegrasjon mot ID-porten
                via spesifikasjonen til `Application`. FÃ¸lgende eksempel konfigurerer en integrasjon av typen `api_klient`,
                setter **redirect path** til `/oauth/callback` og spesifiserer scopes `openid` og `profile`. Resten av feltene som stÃ¸ttes
                kan du finne i Skiperator sin [API-dokumentasjon](../03-skiperator/04-api-docs.md).
```yaml
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: application
  namespace: tilgangsstyring-main
spec:
  image: image
  port: 8080
  idporten:
    enabled: true
    integrationType: "api_klient"
    redirectPath: "/oauth/callback"
    scopes:
      - "openid"
      - "profile"
```
                Fordelen med denne metoden er at Skiperator automatisk injiserer hemmelighetene som Digdirator oppretter
                som miljÃ¸variabler i deploymenten til `application`. Dette gjÃ¸r at applikasjonen enkelt kan fÃ¥ tilgang til
                hemmelighetene under kjÃ¸ring.
            </TabItem>
            <TabItem value="maskinporten" label="Maskinporten">
                [Skiperator](../03-skiperator/04-api-docs.md) tilbyr stÃ¸tte for Ã¥ sette opp en klientintegrasjon mot Maskinporten
                via spesifikasjonen til `Application`. FÃ¸lgende eksempel demonstrerer en minimal konfigurasjon for Ã¥ registrere en klient i Maskinporten.
                Resten av feltene som stÃ¸ttes kan du finne i Skiperator sin [API-dokumentasjon](../03-skiperator/04-api-docs.md).

```yaml
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: application
  namespace: tilgangsstyring-main
spec:
  image: image
  port: 8080
  maskinporten:
    enabled: true
```

                Fordelen med denne metoden er at Skiperator automatisk injiserer hemmelighetene som Digdirator oppretter
                som miljÃ¸variabler i deploymenten til `application`. Dette gjÃ¸r at applikasjonen enkelt kan fÃ¥ tilgang til
                hemmelighetene under kjÃ¸ring.
            </TabItem>
        </Tabs>
    </TabItem>
    <TabItem value="native" label="Digdirator / Azurerator">

        Man kan benytte seg direkte av CRD-ene (Custom Resource Definitions) som Digdirator og Azurerator introduserer for Ã¥ registrere klienter mot ID-porten, Maskinporten og Entra ID.
        Fordelen med denne tilnÃ¦rmingen er at man fÃ¥r full kontroll over konfigurasjonen og stor fleksibilitet ved Ã¥ frikoble registreringen fra applikasjonen.
        Ulempen er at det krever mer innsikt i oppsettet, og at injisering av hemmeligheter i deploymenten mÃ¥ hÃ¥ndteres separat.

        Digdirator introduserer CRD-ene `IdportenClient` og `MaskinportenClient`, som definerer konfigurasjonen for registrering av klienter mot henholdsvis **ID-porten** og **Maskinporten**.
        Azurerator introduserer CRD-en `AzureAdApplication`, som brukes til Ã¥ registrere klienter mot **Microsoft Entra ID**.

        Alle tre CRD-ene fungerer pÃ¥ samme mÃ¥te: De overvÃ¥kes av sine respektive Kubernetes-operatÃ¸rer, som benytter konfigurasjonen til Ã¥ registrere en klient mot den aktuelle identitetstilbyderen.
        Etter registreringen opprettes en Kubernetes-hemmelighet som inneholder nÃ¸dvendige hemmeligheter og relevante URI-er. Disse brukes bÃ¥de til token-validering og for Ã¥ gjennomfÃ¸re ulike OAuth 2.0-flows.

        <Tabs>
            <TabItem value="azurerator" label="AzureAdApplication">
                App-registreringer opprettet med Azureator fÃ¸lger fÃ¸lgende navnekonvensjon basert pÃ¥ `AzureAdApplication`-manifestet: `cluster:namespace:name`.

                ### Spesifikasjonen til `AzureAdApplication`

                <details>
                    <summary><strong>spec</strong> _(required)_ â€“ Spesifikasjon for `AzureAdApplication</summary>

                    <p><strong>allowAllUsers</strong> _(bool, required)_ â€“ Bestemmer om alle brukere i tenanten som Azurerator er konfigurert mot skal fÃ¥ tilgang.</p>

                    <details>
                        <summary><strong>claims</strong> _(object, optional)_ â€“ Definerer konfigurasjon av claims som inkluderes i tokenene som returneres til Entra ID applikasjonen.</summary>
                        <details>
                            <summary><strong>groups</strong> _([]object, optional)_ â€“ En liste over Entra ID gruppe ID-er som skal inkluderes i `groups-claimet i tokenene utstedt av Entra ID. Dette tildeler ogsÃ¥ grupper til app-registreringen brukt for tilgangskontroll. Kun direkte medlemmer av gruppene fÃ¥r tilgang.</summary>
                            <p><strong>id</strong> _(string, required)_ â€“ Objekt-ID-en (OID) til en Entra ID-gruppe.</p>
                        </details>
                    </details>

                    <details>
                        <summary><strong>replyUrls</strong> _([]object, required)_ â€“ URL-er som applikasjonen godtar som svaradresser etter autentisering.</summary>
                        <p><strong>url</strong> _(string, required)_ â€“ En godkjent svaradresse (reply URL) for applikasjonen.</p>
                    </details>

                    <p><strong>logoutUrl</strong> _(string, optional)_ â€“ URL-en brukere blir omdirigert til nÃ¥r de logger ut av applikasjonen..</p>

                    <details>
                        <summary><strong>preAuthorizedApplications</strong> _([]object, optional)_ â€“ Definerer andre app-registreringer som er forhÃ¥ndsautorisert til Ã¥ fÃ¥ tilgang til denne applikasjonen. Her refereres det til tilsvarende `AzureAdApplication`.</summary>
                        <p><strong>application</strong> _(string, required)_ â€“ Navnet pÃ¥ den forhÃ¥ndsgodkjente applikasjonen.</p>
                        <p><strong>namespace</strong> _(string, required)_ â€“ Namespacet hvor den forhÃ¥ndsgodkjente applikasjonen befinner seg.</p>
                        <p><strong>cluster</strong> _(string, required)_ â€“ Clusteret hvor den forhÃ¥ndsgodkjente applikasjonen befinner seg.</p>
                        <details>
                            <summary><strong>permissions</strong> _(object, optional)_ â€“ Spesifiserer hvilke claims den forhÃ¥ndsautoriserte applikasjonen har.</summary>
                            <p><strong>scopes</strong> _([]string, optional)_ â€“ Liste med egendefinerte tilgangs-scopes tildelt til den forhÃ¥ndsautoriserte appliaksjonen.</p>
                            <p><strong>roles</strong> _([]string, optional)_ â€“ Liste med egendefinerte tilgangs-roller tildelt til den forhÃ¥ndsautoriserte appliaksjonen.</p>
                        </details>
                    </details>

                    <p><strong>secretName</strong> _(string, required)_ â€“ Navnet pÃ¥ Kubernetes-hemmeligheten der hemmeligheter og annen informasjon for Entra ID applikasjonen lagres.</p>
                    <p><strong>secretKeyPrefix</strong> _(string, optional)_ â€“ Et valgfritt brukerdefinert prefiks som brukes pÃ¥ nÃ¸klene i den genererte hemmeligheten, og erstatter standardprefikset (AZURE).</p>
                    <p><strong>secretProtected</strong> _(bool, optional)_ â€“ Angir om hemmeligheten skal tilbaketrekkes selv nÃ¥r den ikke er i bruk.</p>
                    <p><strong>singlePageApplication</strong> _(bool, optional)_ â€“ Angir om denne Entra ID-applikasjonen skal registreres som en single-page-application for bruk i klient-side-applikasjoner uten tilgang til hemmeligheter.</p>
                </details>

                ### Eksempel

                FÃ¸lgende eksempel er et YAML-manifest som oppretter app-registreringen `atgcp1-sandbox:tilgangsstyring-main:test-app`.
                Den gir kun tilgang til direkte medlemmer av gruppene med objekt-ID `2720e397-081d-4d9b-852e-0d81f45a304f` eller `c3c94454-aefc-44f9-9076-58ea47547941`.
                Den forhÃ¥ndsautoriserer ogsÃ¥ Entra ID klienten `atgcp1-dev:other-namespace:other-app`.
                NÃ¥r registrering er fullfÃ¸rt vil Azurerator automatisk opprette Kubernetes-hemmeligheten `entraid-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: AzureAdApplication
metadata:
  name: test-app
  namespace: tilgangsstyring-main
spec:
  allowAllUsers: false
  claims:
    groups:
      - id: 2720e397-081d-4d9b-852e-0d81f45a304f
      - id: c3c94454-aefc-44f9-9076-58ea47547941
  replyUrls:
    - url: https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/callback
  preAuthorizedApplications:
    - application: other-app
      namespace: other-namespace
      cluster: atgcp1-dev
```

            </TabItem>
            <TabItem value="idportenclient" label="IdportenClient">
                ## ğŸš§ Under arbeid ğŸš§

                Dette innholdet er under arbeid og forhÃ¥pentligvis straks klart!
            </TabItem>
            <TabItem value="maskinportenclient" label="MaskinportenClient">
                ## ğŸš§ Under arbeid ğŸš§

                Dette innholdet er under arbeid og forhÃ¥pentligvis straks klart!
            </TabItem>
        </Tabs>
    </TabItem>
</Tabs>