# Klientregistrering

FÃ¸r du gÃ¥r i gang med Ã¥ sikre din applikasjon med Ztoperator, sÃ¥ trenger du en klientregistrering hos en identitetstilbyder.
Klientregistrering er en sentral del av tilgangsstyring med OAuth 2.0 og OIDC. NÃ¥r du registrerer en klient, fÃ¥r applikasjonen
sin egen identitet og kan autentisere seg mot de valgte identitetstilbyderne.

NÃ¥r du skal opprette en klientregistrering bÃ¸r du vurdere hvilken identitetstilbyder som passer best til behovene i din applikasjon.
For applikasjoner pÃ¥ SKIP stÃ¥r valget da oftest mellom:

- **Microsoft Entra ID**: Brukes nÃ¥r applikasjonen er ment for internt bruk i Kartverket, og brukerne er ansatte i Kartverket.
- **ID-porten**: Egnet for borgertjenester som skal brukes av Ola og Kari Nordmann.
- **Maskinporten**: Benyttes nÃ¥r applikasjonen tilbyr et API for andre offentlige virksomheter eller nÃ¥r man Ã¸nsker Ã¥ konsumere andre API-er som benytter seg av Maskinporten.
- **Andre**: Hvis identitetstilbyderne over _ikke_ treffer dine behov anbefaler vi deg Ã¥ ta kontakt med Team Tilgangsstyring pÃ¥ [#gen-tilgangsstyring](https://kartverketgroup.slack.com/archives/C08CJLBLY2X) pÃ¥ Slack.

`Audience` er et begrep innen OAuth 2.0 som spesifiserer tiltenkt mottaker av et aksess-token. Det er ofte en unik ID (UID)
eller en unik URL. Hver klientregistrering fÃ¥r sitt eget `audience`, og vi anbefaler Ã¥ ha et bevisst forhold til hvilke tjenester
som skal _dele_ samme `audience`. Det er ofte mer hensiktsmessig Ã¥ velge en restriktiv tilnÃ¦rming, der hver tjeneste fÃ¥r sin egen klientregistrering,
fremfor Ã¥ gruppere flere tjenester under Ã©n felles klient. Dette gir bedre kontroll over tilgangsstyring og sikkerhet.

Felles for alle identitetstilbydere pÃ¥ SKIP er at klientregistrering stÃ¸ttes fra plattformen ved hjelp av Kubernetes-operatorer.

- [**Digdirator**](https://github.com/nais/digdirator) hÃ¥ndterer klientregistrering mot Digdir sine felleslÃ¸sninger: **ID-Porten** og **Maskinporten**.
- [**Azurerator**](https://github.com/nais/azurerator) hÃ¥ndterer klientregistrering mot **Microsoft Entra ID** (tidligere kjent som Azure Active Directory).

NÃ¥r man bruker Digdirator eller Azurerator for Ã¥ opprette en klientintegrasjon, blir det opprettet en Kubernetes-hemmelighet (Secret) i samme namespace med integrasjonshemmeligheter. Disse kan brukes av applikasjoner til bl.a. Ã¥ logge inn brukere, hente maskin-til-maskin-tokens og validere innkommende JWT-er pÃ¥ forespÃ¸rsler.

## ğŸªª Digdirator

[Digdirator](https://https://github.com/nais/digdirator) er en Kubernetes-operator utviklet av NAV sitt plattformteam (NAIS) som skal gjÃ¸re det enkelt Ã¥ deklarativt sette opp og vedlikeholde
integrasjoner mot [Digdir](https://docs.digdir.no) sine systemer. Dette inkluderer **ID-Porten**-integrasjoner og **Maskinporten**-integrasjoner.

Digdirator introduserer to CRD-er, `IDPortenClient` og `MaskinportenClient`, som automatiserer opprettelse og vedlikehold av integrasjoner mot henholdsvis ID-porten og Maskinporten. Alternativt kan klientregistrering gjÃ¸res direkte i et Skiperator-applikasjonsmanifest. Se [her](../03-skiperator/04-api-docs.md) for mer informasjon om hvordan du setter opp ID-porten- og/eller Maskinporten-integrasjoner via Skiperator.

### `IDPortenClient`

En `IDPortenClient` er en CRD som lar brukere deklarativt opprette og vedlikeholde ID-Porten-klientregistreringer.

<details>
    <summary><strong>spec</strong> _(object, required)_ â€“ Spesifikasjon til `IDPortenClient`</summary>

    <p><strong>secretName</strong> _(string, required)_ â€“ Navnet pÃ¥ den resulterende `Secret`-ressursen som vil bli opprettet.</p>

    <p><strong>integrationType</strong> _(string, optional)_ â€“ Definerer integrasjonstypen for klienten. Bestemmer hvilke scopes som kan registreres. Kan ikke endres etter opprettelse. Tillatte verdier: `krr`, `idporten`, `api_klient`.</p>

    <p><strong>scopes</strong> _([]string, optional)_ â€“ Definerer OAuth2-scopes for klienten. Begrenset basert pÃ¥ `integrationType`.</p>

    <p><strong>frontchannelLogoutURI</strong> _(string, optional)_ â€“ URL som ID-porten omdirigere til nÃ¥r en utlogging utlÃ¸ses av en annen applikasjon.</p>

    <p><strong>postLogoutRedirectURIs</strong> _([]string, optional)_ â€“ Liste over gyldige URI-er hvor ID-porten kan omdirigere etter utlogging.</p>

    <p><strong>redirectURIs</strong> _([]string], optional)_ â€“ Liste over redirect URI-er som skal registreres hos DigDir.</p>

    <p><strong>accessTokenLifetime</strong> _(integer, optional)_ â€“ Maksimal levetid i sekunder for `access_token` som returneres fra ID-porten. Min: 1, maks: 3600.</p>

    <p><strong>clientURI</strong> _(string, optional)_ â€“ URL til klienten brukt av DigDir nÃ¥r en 'tilbake'-knapp vises eller ved feil.</p>

    <p><strong>clientName</strong> _(string, optional)_ â€“ Navnet pÃ¥ klienten registrert hos DigDir. Vises under innlogging for brukerorienterte flyter.</p>

    <p><strong>sessionLifetime</strong> _(integer, optional)_ â€“ Maksimal Ã¸ktlevetid i sekunder for en innlogget sluttbruker for denne klienten. Min: 3600, maks: 28800.</p>

    <p><strong>ssoDisabled</strong> _(bool, optional)_ â€“ Kontrollerer Single Sign-On-oppsettet for klienten. Hvis satt til `true`, er SSO deaktivert.</p>

</details>

FÃ¸lgende eksempel registrerer en klientintegrasjon mot ID-porten av typen `idporten`.
NÃ¥r registrering er fullfÃ¸rt vil Digdirator opprette Kubernetes-hemmeligheten `idporten-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: IDPortenClient
metadata:
  name: test-client
  namespace: tilgansstyring-main
spec:
  clientName: Test Application
  clientURI: https://test-app.atgcp1-sandbox.kartverket-intern.cloud
  frontchannelLogoutURI: https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/logout
  integrationType: idporten
  redirectURIs:
    - https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/callback
  scopes:
    - openid
    - profile
  secretName: idporten-secret
```

### `MaskinportenClient`

En `MaskinportenClient` er en CRD som lar brukere deklarativt opprette og vedlikeholde Maskinporten-klientregistreringer.

<details>
    <summary><strong>spec</strong> _(object, required)_ â€“ Spesifikasjon til `MaskinportenClient`</summary>

    <p><strong>secretName</strong> _(string, required)_ â€“ Navnet pÃ¥ den resulterende `Secret`-ressursen som vil bli opprettet.</p>
    <p><strong>clientName</strong> _(string, optional)_ â€“ Navnet pÃ¥ klienten registrert hos DigDir. Vises under innlogging for brukerorienterte flyter, og er ellers en lesbar mÃ¥te Ã¥ skille mellom klienter i DigDirs selvbetjeningsportal.</p>
    <details>
        <summary><strong>scopes</strong> _([]object, optional)_ â€“ Definerer hvilke scopes applikasjonen konsumerer og hvilke den eksponerer.</summary>
        <details>
            <summary><strong>consumes</strong> _([]object, optional)_ â€“ En liste med scopes din klient kan forespÃ¸rre tilgang til.</summary>
            <p><strong>name</strong> _(string, required)_ â€“ Scopene som applikasjonen konsumerer for Ã¥ fÃ¥ tilgang til en ekstern organisasjons API.</p>
        </details>
        <details>
            <summary><strong>exposes</strong> _([]object, optional)_ â€“ En liste med scopes din applikasjon Ã¸nsker Ã¥ eksponere til andre organisasjoner hvor tilgang er basert pÃ¥ organisasjonsnummer.</summary>
            <p><strong>enabled</strong> _(bool, required)_ â€“ Hvis `true`, sÃ¥ er detkonfigurerte scopet tilgjengelig for bruk og til Ã¥ bli konsumert av organisasjoner som har fÃ¥tt godkjent tilgang.</p>
            <p><strong>name</strong> _(string, pÃ¥krevd)_ â€“ Det faktiske sub-scopet kombinert med `product`.</p>
            <p><strong>product</strong> _(string, valgfritt)_ â€“ ProduktomrÃ¥de tilknyttet scopet. Dette vil inkluderes i resultatet: `org:<product><name>`.</p>
            <p><strong>atMaxAge</strong> _(int, valgfritt)_ â€“ Maksimal tillatt levetid for token i sekunder. Defaulter til 30 sekunder.</p>
            <p><strong>allowedIntegrations</strong> _([]string, valgfritt)_ â€“ Liste over tillatte integrasjonstyper for dette eksponerte omfanget. Defaulter til `maskinporten`.</p>
            <details>
                <summary><strong>consumers</strong> _([]object, valgfritt)_ â€“ Liste over eksterne konsumenter som har tilgang til Ã¥ konsumere dette scopet og som kan forespÃ¸rre `access_token`.</summary>
                <p><strong>orgno</strong> â€“ Det eksterne organisasjonsnummeret.</p>
                <p><strong>name</strong> â€“ Beskrivende felt brukt utelukkende for oversikt.</p>
            </details>
            <p><strong>accessibleForAll</strong> â€“ Tillater alle organisasjoner Ã¥ fÃ¥ tilgang til scopet.</p>
            <p><strong>delegationSource</strong> â€“ Delegasjonskilde for scopet. Default er tomt, noe som betyr at ingen delegasjon er tillatt.</p>
            <p><strong>separator</strong> â€“ Tegnet som skiller `product` og `name` i det endelige scopet. Resultatet blir da `<prefix>:<product><separator><name>`. Defaulter til `:` med mindre `name` inneholder `/`, i det tilfellet defaultes det til `/`.</p>
            <p><strong>visibility</strong> â€“ Kontrollerer synligheten til scopet. Offentlige scopes er synlige for alle, mens private scopes kun er synlige for organisasjonen som eier scopet og organisasjoner som har fÃ¥tt tilgang som konsumenter. Defaulter til `public`. Tillatte verdier: `private`, `public`.</p>
        </details>
    </details>
</details>

FÃ¸lgende eksempel oppretter en klientintegrasjon mot Maskinporten og definerer scopet `innsyn`.
Den setter HUSLÃ˜S HURTIG TIGER AS og KOSTBAR LEKKER APE AS som godkjente konsumenter av scopet.
NÃ¥r registrering er fullfÃ¸rt vil Digdirator opprette Kubernetes-hemmeligheten `maskinporten-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: MaskinportenClient
metadata:
  name: test-client
  namespace: tilgangsstyring-main
spec:
  clientName: innsikt-secure-deltashare
  scopes:
    exposes:
      - enabled: true
        name: "innsyn"
        product: "ProduktomrÃ¥de"
        consumers:
          - name: HUSLÃ˜S HURTIG TIGER AS
            orgno: "987654321"
          - name: KOSTBAR LEKKER APE AS
            orgno: "123456789"
  secretName: maskinporten-secret
```

## ğŸ”¹ Azurerator

[Azurerator](https://https://github.com/nais/azurerator) er en Kubernetes-operator utviklet av NAV sitt plattformteam (NAIS) som skal gjÃ¸re det enkelt Ã¥ deklarativt sette opp og vedlikeholde
integrasjoner mot [Microsoft Entra ID](https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/Overview).

### `AzureAdApplication`

Azurerator introduserer CRD-en `AzureAdApplication`, som hÃ¥ndterer opprettelse og vedlikehold av integrasjoner mot Microsoft Entra ID. Registreringer opprettet med Azureator vil fÃ¥ navn basert pÃ¥ hvor de er plassert i et Kubernetes-cluster, i.e. `cluster:namespace:name`.

<details>
    <summary><strong>spec</strong> _(object, required)_ â€“ Spesifikasjon til `AzureAdApplication`</summary>

    <p><strong>allowAllUsers</strong> _(bool, required)_ â€“ Bestemmer om alle brukere i tenanten som Azurerator er konfigurert mot skal fÃ¥ tilgang.</p>

    <details>
        <summary><strong>claims</strong> _(object, optional)_ â€“ Definerer konfigurasjon av claims som inkluderes i tokenene som returneres til Entra ID applikasjonen.</summary>
        <details>
            <summary><strong>groups</strong> _([]object, optional)_ â€“ En liste over Entra ID gruppe ID-er som skal inkluderes i `groups`-claimet i tokenene utstedt av Entra ID. Dette tildeler ogsÃ¥ grupper til app-registreringen brukt for tilgangskontroll. Kun direkte medlemmer av gruppene fÃ¥r tilgang.</summary>
            <p><strong>id</strong> _(string, required)_ â€“ Objekt-ID-en (OID) til en Entra ID-gruppe.</p>
        </details>
    </details>

    <details>
        <summary><strong>replyUrls</strong> _([]object, required)_ â€“ URL-er som applikasjonen godtar som svaradresser etter autentisering.</summary>
        <p><strong>url</strong> _(string, required)_ â€“ En godkjent svaradresse (reply URL) for applikasjonen.</p>
    </details>

    <p><strong>logoutUrl</strong> _(string, optional)_ â€“ URL-en brukere blir omdirigert til nÃ¥r de logger ut av applikasjonen..</p>

    <details>
        <summary><strong>preAuthorizedApplications</strong> _([]object, optional)_ â€“ Definerer andre app-registreringer som er forhÃ¥ndsautorisert til Ã¥ fÃ¥ tilgang til denne applikasjonen. Her refereres det til tilsvarende `AzureAdApplication`.</summary>
        <p><strong>application</strong> _(string, required)_ â€“ Navnet pÃ¥ den forhÃ¥ndsgodkjente applikasjonen.</p>
        <p><strong>namespace</strong> _(string, required)_ â€“ Namespacet hvor den forhÃ¥ndsgodkjente applikasjonen befinner seg.</p>
        <p><strong>cluster</strong> _(string, required)_ â€“ Clusteret hvor den forhÃ¥ndsgodkjente applikasjonen befinner seg.</p>
        <details>
            <summary><strong>permissions</strong> _(object, optional)_ â€“ Spesifiserer hvilke claims den forhÃ¥ndsautoriserte applikasjonen har.</summary>
            <p><strong>scopes</strong> _([]string, optional)_ â€“ Liste med egendefinerte tilgangs-scopes tildelt til den forhÃ¥ndsautoriserte appliaksjonen.</p>
            <p><strong>roles</strong> _([]string, optional)_ â€“ Liste med egendefinerte tilgangs-roller tildelt til den forhÃ¥ndsautoriserte appliaksjonen.</p>
        </details>
    </details>

    <p><strong>secretName</strong> _(string, required)_ â€“ Navnet pÃ¥ den resulterende `Secret`-ressursen som vil bli opprettet.</p>
    <p><strong>secretKeyPrefix</strong> _(string, optional)_ â€“ Et valgfritt brukerdefinert prefiks som brukes pÃ¥ nÃ¸klene i den genererte hemmeligheten, og erstatter standardprefikset (AZURE).</p>
    <p><strong>secretProtected</strong> _(bool, optional)_ â€“ Angir om hemmeligheten skal tilbaketrekkes selv nÃ¥r den ikke er i bruk.</p>
    <p><strong>singlePageApplication</strong> _(bool, optional)_ â€“ Angir om denne Entra ID-applikasjonen skal registreres som en single-page-application for bruk i klient-side-applikasjoner uten tilgang til hemmeligheter.</p>
</details>

FÃ¸lgende eksempel oppretter app-registreringen `atgcp1-sandbox:tilgangsstyring-main:test-app`.
Den gir kun tilgang til direkte medlemmer av gruppene med objekt-ID `2720e397-081d-4d9b-852e-0d81f45a304f` eller `c3c94454-aefc-44f9-9076-58ea47547941`.
Den forhÃ¥ndsautoriserer ogsÃ¥ Entra ID klienten `atgcp1-dev:other-namespace:other-app`.
NÃ¥r registrering er fullfÃ¸rt vil Azurerator opprette Kubernetes-hemmeligheten `entraid-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: AzureAdApplication
metadata:
  name: test-app
  namespace: tilgangsstyring-main
spec:
  allowAllUsers: false
  secretName: entraid-secret
  claims:
    groups:
      - id: 2720e397-081d-4d9b-852e-0d81f45a304f
      - id: c3c94454-aefc-44f9-9076-58ea47547941
  replyUrls:
    - url: https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/callback
  preAuthorizedApplications:
    - application: other-app
      namespace: other-namespace
      cluster: atgcp1-dev
```
