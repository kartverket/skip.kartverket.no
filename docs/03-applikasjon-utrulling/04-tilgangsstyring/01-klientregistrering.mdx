import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Klientregistrering

Klientregistrering er en sentral del av tilgangsstyring med OAuth 2.0 og OIDC. N√•r du registrerer en klient, f√•r applikasjonen
sin egen identitet og kan autentisere seg mot de valgte identitetstilbyderne.

Vi anbefaler √• ha et bevisst forhold til hvilke tjenester som skal dele samme `audience`.
Det er ofte mer hensiktsmessig √• velge en restriktiv tiln√¶rming, der hver tjeneste f√•r sin egen klientregistrering,
fremfor √• gruppere flere tjenester under √©n felles klient. Dette gir bedre kontroll over tilgangsstyring og sikkerhet.

Felles for alle identitetstilbydere p√• SKIP er at klientregistrering st√∏ttes fra plattformen ved hjelp av Kubernetes-operatorer.

- [**Digdirator**](https://github.com/nais/digdirator) h√•ndterer klientregistrering mot Digdir sine fellesl√∏sninger: **ID-porten** og **Maskinporten**.
- [**Azurerator**](https://github.com/nais/azurerator) h√•ndterer klientregistrering mot **Microsoft Entra ID** (tidligere kjent som Azure Active Directory).

N√•r man skal registrere en klient mot en eller flere av identitetstilbyderne, har man tre valg.
Man kan benytte seg av [Skiperator](../03-skiperator/index.md) dersom klientregistreringen h√∏rer til en SKIP-applikasjon.
Alternativt kan man bruke CRD-ene fra [Digdirator](https://github.com/nais/digdirator) og [Azurerator](https://github.com/nais/azurerator) direkte.



<Tabs queryString={"operator"}>
    <TabItem value="native" label="Digdirator / Azurerator">

        Hvis en √∏nsker √• opprette en klientintegrasjon uten √• knytte den til en Skiperator-applikasjon, kan man benytte seg av CRD-ene som Digdirator og Azurerator introduserer direkte.
        Dette gj√∏r det mulig √• opprette og vedlikeholde klientregistreringen uavhengig av en spesifikk applikasjon i Skiperator.

        Fordelen med denne tiln√¶rmingen er at man f√•r full kontroll over konfigurasjonen og stor fleksibilitet ved √• frikoble registreringen fra applikasjonen.
        Ulempen er at det krever mer innsikt i oppsettet, og at [injisering av hemmeligheter i deploymenten m√• h√•ndteres separat](../03-skiperator/03-configuring.md#environment-variables).

        <Tabs queryString={"idp"}>
            <TabItem value="entraid" label="Entra ID">
                En kan registrere en klient mot Entra ID ved √• opprette en `AzureAdApplication`-ressurs.
                Registreringer opprettet med Azureator f√∏lger f√∏lgende navnekonvensjon basert p√• `AzureAdApplication`-manifestet: `cluster:namespace:name`.

                ### Spesifikasjonen til `AzureAdApplication`

                <details>
                    <summary><strong>spec</strong> _(object, required)_ ‚Äì Spesifikasjon til `AzureAdApplication`</summary>

                    <p><strong>allowAllUsers</strong> _(bool, required)_ ‚Äì Bestemmer om alle brukere i tenanten som Azurerator er konfigurert mot skal f√• tilgang.</p>

                    <details>
                        <summary><strong>claims</strong> _(object, optional)_ ‚Äì Definerer konfigurasjon av claims som inkluderes i tokenene som returneres til Entra ID applikasjonen.</summary>
                        <details>
                            <summary><strong>groups</strong> _([]object, optional)_ ‚Äì En liste over Entra ID gruppe ID-er som skal inkluderes i `groups`-claimet i tokenene utstedt av Entra ID. Dette tildeler ogs√• grupper til app-registreringen brukt for tilgangskontroll. Kun direkte medlemmer av gruppene f√•r tilgang.</summary>
                            <p><strong>id</strong> _(string, required)_ ‚Äì Objekt-ID-en (OID) til en Entra ID-gruppe.</p>
                        </details>
                    </details>

                    <details>
                        <summary><strong>replyUrls</strong> _([]object, required)_ ‚Äì URL-er som applikasjonen godtar som svaradresser etter autentisering.</summary>
                        <p><strong>url</strong> _(string, required)_ ‚Äì En godkjent svaradresse (reply URL) for applikasjonen.</p>
                    </details>

                    <p><strong>logoutUrl</strong> _(string, optional)_ ‚Äì URL-en brukere blir omdirigert til n√•r de logger ut av applikasjonen..</p>

                    <details>
                        <summary><strong>preAuthorizedApplications</strong> _([]object, optional)_ ‚Äì Definerer andre app-registreringer som er forh√•ndsautorisert til √• f√• tilgang til denne applikasjonen. Her refereres det til tilsvarende `AzureAdApplication`.</summary>
                        <p><strong>application</strong> _(string, required)_ ‚Äì Navnet p√• den forh√•ndsgodkjente applikasjonen.</p>
                        <p><strong>namespace</strong> _(string, required)_ ‚Äì Namespacet hvor den forh√•ndsgodkjente applikasjonen befinner seg.</p>
                        <p><strong>cluster</strong> _(string, required)_ ‚Äì Clusteret hvor den forh√•ndsgodkjente applikasjonen befinner seg.</p>
                        <details>
                            <summary><strong>permissions</strong> _(object, optional)_ ‚Äì Spesifiserer hvilke claims den forh√•ndsautoriserte applikasjonen har.</summary>
                            <p><strong>scopes</strong> _([]string, optional)_ ‚Äì Liste med egendefinerte tilgangs-scopes tildelt til den forh√•ndsautoriserte appliaksjonen.</p>
                            <p><strong>roles</strong> _([]string, optional)_ ‚Äì Liste med egendefinerte tilgangs-roller tildelt til den forh√•ndsautoriserte appliaksjonen.</p>
                        </details>
                    </details>

                    <p><strong>secretName</strong> _(string, required)_ ‚Äì Navnet p√• den resulterende `Secret`-ressursen som vil bli opprettet.</p>
                    <p><strong>secretKeyPrefix</strong> _(string, optional)_ ‚Äì Et valgfritt brukerdefinert prefiks som brukes p√• n√∏klene i den genererte hemmeligheten, og erstatter standardprefikset (AZURE).</p>
                    <p><strong>secretProtected</strong> _(bool, optional)_ ‚Äì Angir om hemmeligheten skal tilbaketrekkes selv n√•r den ikke er i bruk.</p>
                    <p><strong>singlePageApplication</strong> _(bool, optional)_ ‚Äì Angir om denne Entra ID-applikasjonen skal registreres som en single-page-application for bruk i klient-side-applikasjoner uten tilgang til hemmeligheter.</p>
                </details>

                ### Eksempel

                F√∏lgende eksempel oppretter app-registreringen `atgcp1-sandbox:tilgangsstyring-main:test-app`.
                Den gir kun tilgang til direkte medlemmer av gruppene med objekt-ID `2720e397-081d-4d9b-852e-0d81f45a304f` eller `c3c94454-aefc-44f9-9076-58ea47547941`.
                Den forh√•ndsautoriserer ogs√• Entra ID klienten `atgcp1-dev:other-namespace:other-app`.
                N√•r registrering er fullf√∏rt vil Azurerator opprette Kubernetes-hemmeligheten `entraid-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: AzureAdApplication
metadata:
  name: test-app
  namespace: tilgangsstyring-main
spec:
  allowAllUsers: false
  secretName: entraid-secret
  claims:
    groups:
      - id: 2720e397-081d-4d9b-852e-0d81f45a304f
      - id: c3c94454-aefc-44f9-9076-58ea47547941
  replyUrls:
    - url: https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/callback
  preAuthorizedApplications:
    - application: other-app
      namespace: other-namespace
      cluster: atgcp1-dev
```

            </TabItem>
            <TabItem value="idporten" label="ID-porten">
                En kan registrere en klient mot ID-porten ved √• opprette en `IDPortenClient`-ressurs.

                ### Spesifikasjonen til `IDPortenClient`

                <details>
                    <summary><strong>spec</strong> _(object, required)_ ‚Äì Spesifikasjon til `IDPortenClient`</summary>

                    <p><strong>secretName</strong> _(string, required)_ ‚Äì Navnet p√• den resulterende `Secret`-ressursen som vil bli opprettet.</p>

                    <p><strong>integrationType</strong> _(string, optional)_ ‚Äì Definerer integrasjonstypen for klienten. Bestemmer hvilke scopes som kan registreres. Kan ikke endres etter opprettelse. Tillatte verdier: `krr`, `idporten`, `api_klient`.</p>

                    <p><strong>scopes</strong> _([]string, optional)_ ‚Äì Definerer OAuth2-scopes for klienten. Begrenset basert p√• `integrationType`.</p>

                    <p><strong>frontchannelLogoutURI</strong> _(string, optional)_ ‚Äì URL som ID-porten omdirigere til n√•r en utlogging utl√∏ses av en annen applikasjon.</p>

                    <p><strong>postLogoutRedirectURIs</strong> _([]string, optional)_ ‚Äì Liste over gyldige URI-er hvor ID-porten kan omdirigere etter utlogging.</p>

                    <p><strong>redirectURIs</strong> _([]string], optional)_ ‚Äì Liste over redirect URI-er som skal registreres hos DigDir.</p>

                    <p><strong>accessTokenLifetime</strong> _(integer, optional)_ ‚Äì Maksimal levetid i sekunder for `access_token` som returneres fra ID-porten. Min: 1, maks: 3600.</p>

                    <p><strong>clientURI</strong> _(string, optional)_ ‚Äì URL til klienten brukt av DigDir n√•r en 'tilbake'-knapp vises eller ved feil.</p>

                    <p><strong>clientName</strong> _(string, optional)_ ‚Äì Navnet p√• klienten registrert hos DigDir. Vises under innlogging for brukerorienterte flyter.</p>

                    <p><strong>sessionLifetime</strong> _(integer, optional)_ ‚Äì Maksimal √∏ktlevetid i sekunder for en innlogget sluttbruker for denne klienten. Min: 3600, maks: 28800.</p>

                    <p><strong>ssoDisabled</strong> _(bool, optional)_ ‚Äì Kontrollerer Single Sign-On-oppsettet for klienten. Hvis satt til `true`, er SSO deaktivert.</p>
                </details>

                ### Eksempel

                F√∏lgende eksempel registrerer en klientintegrasjon mot ID-porten av typen `idporten`.
                N√•r registrering er fullf√∏rt vil Digdirator opprette Kubernetes-hemmeligheten `idporten-secret` i namespacet `tilgangsstyring-main`.

```yaml
apiVersion: nais.io/v1
kind: IDPortenClient
metadata:
  name: test-client
  namespace: tilgansstyring-main
spec:
  clientName: Test Application
  clientURI: https://test-app.atgcp1-sandbox.kartverket-intern.cloud
  frontchannelLogoutURI: https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/logout
  integrationType: idporten
  redirectURIs:
  - https://test-app.atgcp1-sandbox.kartverket-intern.cloud/oauth2/callback
  scopes:
  - openid
  - profile
  secretName: idporten-secret
```

            </TabItem>
            <TabItem value="maskinporten" label="Maskinporten">
                En kan registrere en klient mot Maskinporten ved √• opprette en `MaskinportenClient`-ressurs.

                ### Spesifikasjonen til `MaskinportenClient`

                <details>
                    <summary><strong>spec</strong> _(object, required)_ ‚Äì Spesifikasjon til `MaskinportenClient`</summary>

                    <p><strong>secretName</strong> _(string, required)_ ‚Äì Navnet p√• den resulterende `Secret`-ressursen som vil bli opprettet.</p>
                    <p><strong>clientName</strong> _(string, optional)_ ‚Äì Navnet p√• klienten registrert hos DigDir. Vises under innlogging for brukerorienterte flyter, og er ellers en lesbar m√•te √• skille mellom klienter i DigDirs selvbetjeningsportal.</p>
                    <details>
                        <summary><strong>scopes</strong> _([]object, optional)_ ‚Äì Definerer hvilke scopes applikasjonen konsumerer og hvilke den eksponerer.</summary>
                        <details>
                            <summary><strong>consumes</strong> _([]object, optional)_ ‚Äì En liste med scopes din klient kan foresp√∏rre tilgang til.</summary>
                            <p><strong>name</strong> _(string, required)_ ‚Äì Scopene som applikasjonen konsumerer for √• f√• tilgang til en ekstern organisasjons API.</p>
                        </details>
                        <details>
                            <summary><strong>exposes</strong> _([]object, optional)_ ‚Äì En liste med scopes din applikasjon √∏nsker √• eksponere til andre organisasjoner hvor tilgang er basert p√• organisasjonsnummer.</summary>
                            <p><strong>enabled</strong> _(bool, required)_ ‚Äì Hvis `true`, s√• er detkonfigurerte scopet tilgjengelig for bruk og til √• bli konsumert av organisasjoner som har f√•tt godkjent tilgang.</p>
                            <p><strong>name</strong> _(string, p√•krevd)_ ‚Äì Det faktiske sub-scopet kombinert med `product`.</p>
                            <p><strong>product</strong> _(string, valgfritt)_ ‚Äì Produktomr√•de tilknyttet scopet. Dette vil inkluderes i resultatet: `org:<product><name>`.</p>
                            <p><strong>atMaxAge</strong> _(int, valgfritt)_ ‚Äì Maksimal tillatt levetid for token i sekunder. Defaulter til 30 sekunder.</p>
                            <p><strong>allowedIntegrations</strong> _([]string, valgfritt)_ ‚Äì Liste over tillatte integrasjonstyper for dette eksponerte omfanget. Defaulter til `maskinporten`.</p>
                            <details>
                                <summary><strong>consumers</strong> _([]object, valgfritt)_ ‚Äì Liste over eksterne konsumenter som har tilgang til √• konsumere dette scopet og som kan foresp√∏rre `access_token`.</summary>
                                <p><strong>orgno</strong> ‚Äì Det eksterne organisasjonsnummeret.</p>
                                <p><strong>name</strong> ‚Äì Beskrivende felt brukt utelukkende for oversikt.</p>
                            </details>
                            <p><strong>accessibleForAll</strong> ‚Äì Tillater alle organisasjoner √• f√• tilgang til scopet.</p>
                            <p><strong>delegationSource</strong> ‚Äì Delegasjonskilde for scopet. Default er tomt, noe som betyr at ingen delegasjon er tillatt.</p>
                            <p><strong>separator</strong> ‚Äì Tegnet som skiller `product` og `name` i det endelige scopet. Resultatet blir da `<prefix>:<product><separator><name>`. Defaulter til `:` med mindre `name` inneholder `/`, i det tilfellet defaultes det til `/`.</p>
                            <p><strong>visibility</strong> ‚Äì Kontrollerer synligheten til scopet. Offentlige scopes er synlige for alle, mens private scopes kun er synlige for organisasjonen som eier scopet og organisasjoner som har f√•tt tilgang som konsumenter. Defaulter til `public`. Tillatte verdier: `private`, `public`.</p>
                        </details>
                    </details>
                </details>

                ### Eksempel

                F√∏lgende eksempel registrerer en klientintegrasjon mot Maskinporten og definerer scopet `innsyn`.
                Den setter HUSL√òS HURTIG TIGER AS og KOSTBAR LEKKER APE AS som godkjente konsumenter av scopet.
                N√•r registrering er fullf√∏rt vil Digdirator opprette Kubernetes-hemmeligheten `maskinporten-secret` i namespacet `tilgangsstyring-main`.
```yaml
apiVersion: nais.io/v1
kind: MaskinportenClient
metadata:
  name: test-client
  namespace: tilgangsstyring-main
spec:
  clientName: innsikt-secure-deltashare
  scopes:
    exposes:
    - enabled: true
      name: "innsyn"
      product: "Produktomr√•de"
      consumers:
      - name: HUSL√òS HURTIG TIGER AS
        orgno: "987654321"
      - name: KOSTBAR LEKKER APE AS
        orgno: "123456789"
  secretName: maskinporten-secret
```
            </TabItem>
        </Tabs>
    </TabItem>
    <TabItem value="skiperator" label="Skiperator">

        Skiperator tilbyr et forenklet API i CRD-en `Application` for √• registrere klienter mot **ID-porten** og **Maskinporten**.
        Det jobbes ogs√• med et forenklet API for √• registrere klienter mot **Entra ID**, men dette er ikke helt klart enn√•.

        Fordelen med √• benytte Skiperator for klientregistrering er at hemmelighetene som Digdirator oppretter blir automatisk injisert som milj√∏variabler i deploymenten til applikasjonen.
        Dette gj√∏r at applikasjonen enkelt kan f√• tilgang til hemmelighetene i et kj√∏retidsmilj√∏.

        <Tabs queryString={"idp"}>
            <TabItem value="entraid" label="Entra ID">
               ### üöß UNDER UTVIKLING üöß
               Opprettelse av app-registrering i Entra ID via spesifikasjonen til `Application` jobbes med, men er ikke klart helt enn√•.
            </TabItem>
            <TabItem value="idporten" label="ID-porten">
                [Skiperator](../03-skiperator/index.md) tilbyr st√∏tte for √• sette opp en klientintegrasjon mot ID-porten
                via spesifikasjonen til `Application`.

                Eksempelet under setter opp en integrasjon mot ID-porten med f√∏lgende konfigurasjon.
                - Integrasjonstypen settes til `api_klient`.
                - Redirect path settes til `/oauth/callback`.
                - Scopene `openid` og `profile` settes.

                Resten av feltene som st√∏ttes kan du finne i Skiperator sin [API-dokumentasjon](../03-skiperator/04-api-docs.md).
```yaml
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: application
  namespace: tilgangsstyring-main
spec:
  image: image
  port: 8080
// diff-add-start
  idporten:
    enabled: true
    integrationType: "api_klient"
    redirectPath: "/oauth/callback"
    scopes:
      - "openid"
      - "profile"
// diff-add-end
```
            </TabItem>
            <TabItem value="maskinporten" label="Maskinporten">
                [Skiperator](../03-skiperator/index.md) tilbyr st√∏tte for √• sette opp en klientintegrasjon mot Maskinporten
                via spesifikasjonen til `Application`.

                Eksempelet under setter opp en integrasjon mot Maskinporten med f√∏lgende konfigurasjon.
                - Scopet `innsyn` opprettes og organisasjonene HUSL√òS HURTIG TIGER AS og KOSTBAR LEKKER APE AS
                settes som godkjente konsumenter av dette scopet.

                Resten av feltene som st√∏ttes kan du finne i Skiperator sin [API-dokumentasjon](../03-skiperator/04-api-docs.md).


```yaml
apiVersion: skiperator.kartverket.no/v1alpha1
kind: Application
metadata:
  name: application
  namespace: tilgangsstyring-main
spec:
  image: image
  port: 8080
// diff-add-start
  maskinporten:
    enabled: true
    scopes:
      exposes:
      - name: "innsyn"
        enabled: true
        product: "Produktomr√•de"
        consumers:
        - name: HUSL√òS HURTIG TIGER AS
          orgno: "987654321"
        - name: KOSTBAR LEKKER APE AS
          orgno: "123456789"
// diff-add-end
```
            </TabItem>
        </Tabs>
    </TabItem>
</Tabs>


