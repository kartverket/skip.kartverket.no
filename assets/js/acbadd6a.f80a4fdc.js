"use strict";(self.webpackChunkskip_docs=self.webpackChunkskip_docs||[]).push([[7095],{12742:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"applikasjon-utrulling/github-actions/tilgang-til-repoer-med-tokens-fra-github-actions","title":"Tilgang til repoer med tokens fra GitHub Actions","description":"Det vil ofte v\xe6re slik at man trenger tilgang til andre repoer, for eksempel for \xe5 skrive inn en ny versjon i et apps-repo. I disse tilfellene har man ofte brukt GitHub sine Personal Access Tokens (PAT), og dette fungerer helt greit. Det er derimot ikke en ideell l\xf8sning.","source":"@site/docs/03-applikasjon-utrulling/08-github-actions/tilgang-til-repoer-med-tokens-fra-github-actions.md","sourceDirName":"03-applikasjon-utrulling/08-github-actions","slug":"/applikasjon-utrulling/github-actions/tilgang-til-repoer-med-tokens-fra-github-actions","permalink":"/docs/applikasjon-utrulling/github-actions/tilgang-til-repoer-med-tokens-fra-github-actions","draft":false,"unlisted":false,"editUrl":"https://github.com/kartverket/skip-docs/edit/main/docs/03-applikasjon-utrulling/08-github-actions/tilgang-til-repoer-med-tokens-fra-github-actions.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Tilgang til on-prem infrastruktur fra GitHub Actions","permalink":"/docs/applikasjon-utrulling/github-actions/tilgang-til-on-prem-infrastruktur-fra-github-actions"},"next":{"title":"\ud83d\ude80 Argo CD","permalink":"/docs/applikasjon-utrulling/argo-cd/"}}');var i=n(74848),s=n(28453);const o={},a="Tilgang til repoer med tokens fra GitHub Actions",l={},d=[{value:"Secure Token Service (STS)",id:"secure-token-service-sts",level:2},{value:"Etablere tillit",id:"etablere-tillit",level:3},{value:"F\xe5 tilgang",id:"f\xe5-tilgang",level:3}];function c(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"tilgang-til-repoer-med-tokens-fra-github-actions",children:"Tilgang til repoer med tokens fra GitHub Actions"})}),"\n",(0,i.jsx)(t.p,{children:"Det vil ofte v\xe6re slik at man trenger tilgang til andre repoer, for eksempel for \xe5 skrive inn en ny versjon i et apps-repo. I disse tilfellene har man ofte brukt GitHub sine Personal Access Tokens (PAT), og dette fungerer helt greit. Det er derimot ikke en ideell l\xf8sning."}),"\n",(0,i.jsx)(t.p,{children:"Ulempene med PAT-er er todelt. For det f\xf8rste har de en levetid p\xe5 maks 90 dager f\xf8r de m\xe5 fornyes. Om de ikke fornyes vil handlingen som avhenger av tokenet slutte \xe5 fungere, og det kan for eksempel f\xf8re til at deployments stopper opp. I dette tilfellet er man avhengig av at personen som laget tokenet g\xe5r inn og fornyer det, og da blir man ogs\xe5 s\xe5rbar for frav\xe6r og oppsigelser."}),"\n",(0,i.jsx)(t.p,{children:"Den andre utfordringen er at tokenene er \u201clanglevde\u201d. Det vil si at selv om de m\xe5 fornyes jevnlig vil det bety at dersom en token lekkes til en angriper vil den personen ha opp til 90 dager \xe5 misbruke tokenet p\xe5. Det f\xf8rer til at man m\xe5 ivareta disse tokenene p\xe5 en sv\xe6rt god m\xe5te for \xe5 hindre misbruk."}),"\n",(0,i.jsx)(t.p,{children:"Disse ulempene har f\xf8rt til at mange har etterspurt bedre l\xf8sninger enn GitHub PAT-er."}),"\n",(0,i.jsx)(t.h2,{id:"secure-token-service-sts",children:"Secure Token Service (STS)"}),"\n",(0,i.jsxs)(t.p,{children:["En Secure Token Service (STS) er en tjeneste som utsteder sikkerhetstokener som kan brukes til autentisering og autorisering i ulike systemer og applikasjoner. I v\xe5rt tilfelle \xf8nsker vi \xe5 utstede kortlevde tokens som kun er gyldige i perioden de brukes som en erstatning for PAT-er. Vi har derfor implementert et verkt\xf8y som heter ",(0,i.jsx)(t.a,{href:"https://github.com/apps/octo-sts",children:"Octo STS"})," for \xe5 levere denne funksjonaliteten."]}),"\n",(0,i.jsx)(t.p,{children:"M\xe5ten STS fungerer p\xe5 er at man etablerer tillit mellom to repoer. Dette gj\xf8res ved \xe5 legge inn en konfigurasjonsfil i repoet du \xf8nsker \xe5 ha tilgang til som sier noe om hvem som skal kunne f\xe5 tilgang til repoet. Deretter bruker man en ferdig GitHub action i repot som skal f\xe5 tilgang til \xe5 etablere et kortlevd tiken via STS-tjenesten."}),"\n",(0,i.jsxs)(t.p,{children:["Les ",(0,i.jsx)(t.a,{href:"https://www.chainguard.dev/unchained/the-end-of-github-pats-you-cant-leak-what-you-dont-have",children:"denne artikkelen"})," for mer detaljer om Octo STS."]}),"\n",(0,i.jsx)(t.h3,{id:"etablere-tillit",children:"Etablere tillit"}),"\n",(0,i.jsxs)(t.p,{children:["F\xf8rst m\xe5 man etablere tillit ved \xe5 legge inn en config-fil i repoet man skal f\xe5 tilgang til. Dette legges i mappen ",(0,i.jsx)(t.code,{children:".github/chainguard/<navn>.sts.yaml"})," . Erstatt ",(0,i.jsx)(t.code,{children:"<navn>"})," med identiteten som skal ha tilgang og bruk dette navnet i GitHub actionen senere."]}),"\n",(0,i.jsxs)(t.p,{children:["Eksempelet under viser hvordan man gir tilgang fra GitHub actions som kj\xf8rer p\xe5 repoet ",(0,i.jsx)(t.code,{children:"kartverket/mittrepo"})," p\xe5 branchen ",(0,i.jsx)(t.code,{children:"main"})," ."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"issuer: https://token.actions.githubusercontent.com\nsubject: repo:kartverket/mittrepo:ref:refs/heads/main\n\npermissions:\n  contents: write\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Dersom du \xf8nsker \xe5 bruke et wildcard til \xe5 gi tilgang, for eksempel dersom det deployes ved hjelp av \u201cenvironments\u201d i GitHub slik at dette blir subjektet ditt kan man bruke et ",(0,i.jsx)(t.code,{children:"subject_pattern"})," . Dette er et regex."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"issuer: https://token.actions.githubusercontent.com\nsubject_pattern: repo:kartverket\\/mittrepo:environment:(sandbox|prod)\n\npermissions:\n  contents: write\n"})}),"\n",(0,i.jsx)(t.h3,{id:"f\xe5-tilgang",children:"F\xe5 tilgang"}),"\n",(0,i.jsx)(t.p,{children:"N\xe5r man skal ha tilgang til dette repoet s\xe5 bruker man en GitHub action til \xe5 snakke med STS-tjenesten og f\xe5 en kortlevd token som brukes p\xe5 samme m\xe5te som en PAT. For en deploy til et apps-repo kan du for eksempel skrive f\xf8lgende i din GitHub action:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"permissions:\n  id-token: write # Required for Octo STS\n\nsteps:\n- uses: octo-sts/action@6177b4481c00308b3839969c3eca88c96a91775f # v1.0.0\n  id: octo-sts\n  with:\n    scope: kartverket/skip-apps\n    identity: utviklerportal\n\n- name: Checkout apps repo\n  uses: actions/checkout@v4\n  with:\n    repository: kartverket/skip-apps\n    token: ${{ steps.octo-sts.outputs.token }}\n"})}),"\n",(0,i.jsx)(t.p,{children:"N\xe5r dette blir kj\xf8rt vil det bli gjort en sp\xf8rring til Octo STS-tjenesten, som deretter sjekker filen vi laget i repoet over og om det har blitt etablert tillit. Dersom dette er tilfellet s\xe5 genereres en token som brukes i dette eksempelet til \xe5 sjekke ut et annet repo."}),"\n",(0,i.jsxs)(t.p,{children:["Se ogs\xe5 ",(0,i.jsx)(t.a,{href:"https://github.com/octo-sts/action",children:"https://github.com/octo-sts/action"})," for dokumentasjon p\xe5 GitHub actionen."]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var r=n(96540);const i={},s=r.createContext(i);function o(e){const t=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);