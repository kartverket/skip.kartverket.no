"use strict";(self.webpackChunkskip_docs=self.webpackChunkskip_docs||[]).push([[9831],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>l});var r=n(96540);const i={},s=r.createContext(i);function o(e){const t=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:t},e.children)}},62972:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"applikasjon-utrulling/tilgangsstyring/ztoperator/ztoperator-example","title":"Eksempeloppsett av Ztoperator","description":"For \xe5 illustrere hvordan en Ztoperator-AuthPolicy fungerer, kan vi se p\xe5 f\xf8lgende eksempel-applikasjon kalt demo-app. demo-app er en Python-applikasjon med et enkelt REST-API, som ogs\xe5 distribuerer en Single Page Application (SPA). I kildekoden til demo-app finnes det ingen mekanismer for tilgangsstyring eller beskyttelse av REST-API-endepunktene, og den har heller ikke funksjonalitet for \xe5 logge inn brukere med Microsoft Entra ID. Ztoperator-AuthPolicyen tar seg av alt dette.","source":"@site/docs/03-applikasjon-utrulling/04-tilgangsstyring/01-ztoperator/01-ztoperator-example.mdx","sourceDirName":"03-applikasjon-utrulling/04-tilgangsstyring/01-ztoperator","slug":"/applikasjon-utrulling/tilgangsstyring/ztoperator/ztoperator-example","permalink":"/docs/applikasjon-utrulling/tilgangsstyring/ztoperator/ztoperator-example","draft":false,"unlisted":false,"editUrl":"https://github.com/kartverket/skip-docs/edit/main/docs/03-applikasjon-utrulling/04-tilgangsstyring/01-ztoperator/01-ztoperator-example.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u26d4\ufe0f Ztoperator","permalink":"/docs/applikasjon-utrulling/tilgangsstyring/ztoperator/"},"next":{"title":"Ztoperator API Reference","permalink":"/docs/applikasjon-utrulling/tilgangsstyring/ztoperator/ztoperator-api-docs"}}');var i=n(74848),s=n(28453);const o={},l="Eksempeloppsett av Ztoperator",a={},d=[{value:"\ud83d\udd39 <code>AzureAdApplication</code>",id:"-azureadapplication",level:2},{value:"\ud83e\udd16 Skiperator-<code>Application</code>",id:"-skiperator-application",level:2},{value:"\u26d4\ufe0f Ztoperator-<code>AuthPolicy</code>",id:"\ufe0f-ztoperator-authpolicy",level:2},{value:"<code>spec.enabled</code>",id:"specenabled",level:3},{value:"<code>spec.selector</code>",id:"specselector",level:3},{value:"<code>spec.wellKnownURI</code>",id:"specwellknownuri",level:3},{value:"<code>spec.audience</code>",id:"specaudience",level:3},{value:"<code>spec.ignoreAuthRules</code>",id:"specignoreauthrules",level:3},{value:"<code>spec.authRules</code>",id:"specauthrules",level:3},{value:"<code>spec.autoLogin</code>",id:"specautologin",level:3},{value:"<code>spec.oAuthCredentials</code>",id:"specoauthcredentials",level:3},{value:"<code>spec.outputClaimToHeaders</code>",id:"specoutputclaimtoheaders",level:3},{value:"\ud83d\udc40 Lett \xe5 overse",id:"-lett-\xe5-overse",level:2},{value:"Audience-begrensing i ID-porten og Maksinporten",id:"audience-begrensing-i-id-porten-og-maksinporten",level:3},{value:"Client authentication",id:"client-authentication",level:3}];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"eksempeloppsett-av-ztoperator",children:"Eksempeloppsett av Ztoperator"})}),"\n",(0,i.jsxs)(t.p,{children:["For \xe5 illustrere hvordan en Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," fungerer, kan vi se p\xe5 f\xf8lgende eksempel-applikasjon kalt ",(0,i.jsx)(t.a,{href:"https://demo-app.atgcp1-sandbox.kartverket.cloud/",children:"demo-app"}),". ",(0,i.jsx)(t.code,{children:"demo-app"})," er en Python-applikasjon med et enkelt REST-API, som ogs\xe5 distribuerer en Single Page Application (SPA). I kildekoden til ",(0,i.jsx)(t.code,{children:"demo-app"})," finnes det ",(0,i.jsx)(t.strong,{children:"ingen"})," mekanismer for tilgangsstyring eller beskyttelse av REST-API-endepunktene, og den har heller ",(0,i.jsx)(t.strong,{children:"ikke"})," funksjonalitet for \xe5 logge inn brukere med Microsoft Entra ID. Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicyen"})," tar seg av alt dette."]}),"\n",(0,i.jsxs)(t.p,{children:["Kildekoden til ",(0,i.jsx)(t.code,{children:"demo-app"})," kan finnes p\xe5 ",(0,i.jsx)(t.a,{href:"https://github.com/kartverket/skip-tilgangsstyring-demo",children:"github.com/kartverket/skip-tilgangsstyring-demo"}),". Dette repoet lar deg ogs\xe5 teste og verifisere oppf\xf8rselen til Ztoperator med et lokalt Kubernetes-cluster som likner p\xe5 SKIP."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"demo-app"})," best\xe5r av ",(0,i.jsx)(t.em,{children:"tre"})," ressurser:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["En ",(0,i.jsx)(t.code,{children:"AzureAdApplication"})," som setter opp en klientregistrering mot Kartverkets Microsoft Entra ID."]}),"\n",(0,i.jsxs)(t.li,{children:["En Skiperator-",(0,i.jsx)(t.code,{children:"Application"})," som enkelt ruller ut applikasjonen p\xe5 SKIP."]}),"\n",(0,i.jsxs)(t.li,{children:["En Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," som h\xe5ndhever at angitte endepunkter ",(0,i.jsx)(t.strong,{children:"m\xe5"})," presentere et gyldig ",(0,i.jsx)(t.code,{children:"access_token"}),", og i tillegg logger inn brukere der det er angitt."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Manifestene for disse ressursene finner du i ",(0,i.jsx)(t.a,{href:"https://github.com/kartverket/tilgangsstyring-apps/tree/main/env/atgcp1-sandbox/ztoperator-demo",children:"tilgangsstyring-apps p\xe5 GitHub"}),"."]}),"\n",(0,i.jsxs)(t.h2,{id:"-azureadapplication",children:["\ud83d\udd39 ",(0,i.jsx)(t.code,{children:"AzureAdApplication"})]}),"\n",(0,i.jsxs)(t.p,{children:["F\xf8r man g\xe5r i gang med \xe5 sette opp en Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," m\xe5 man ha en klienregistrering opprettet hos en OAuth 2.0 identitetstilbyder. Ettersom ",(0,i.jsx)(t.code,{children:"demo-app"})," er ment for intern bruk av Kartverket-ansatte, s\xe5 er Microsoft Entra ID en passende identitetstilbyder. En ",(0,i.jsx)(t.code,{children:"AzureAdApplication"})," kan brukes for \xe5 opprette klientregistreringen, og f\xf8lgende manifest oppretter en. Den er konfigurert til \xe5 tillate alle brukere innenfor Kartverket's Entra ID tenant, og har en redirect-url som peker til applikasjonen sin konfiguererte redirect-url. Dette er noe vi senere konfigurerer i Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicyen"}),", og Ztoperator h\xe5ndterer dette endepunktet for oss. Etter \xe5 ha opprettet en klientregistrering i Microsoft Entra ID oppretter Azurerator ogs\xe5 en Kubernetes-hemmelighet kalt ",(0,i.jsx)(t.code,{children:"entraid-secret"}),". Klientregistreringen kan ses i ",(0,i.jsx)(t.a,{href:"https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/dcc29452-1fbc-4805-aeb9-cdb8f4e62147/isMSAApp~/false",children:"Azure Portal"}),"."]}),"\n",(0,i.jsx)(t.admonition,{type:"note",children:(0,i.jsxs)(t.p,{children:["Redirect-url er noe ",(0,i.jsx)(t.code,{children:"demo-app"})," ikke trenger \xe5 forholde seg til. Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," konfigures med en redirect-url n\xe5r man konfigurerer innlogging av brukere, og h\xe5ndterer ",(0,i.jsx)(t.a,{href:"https://datatracker.ietf.org/doc/html/rfc6749#section-1.3.1",children:"callbacks i authorization code flow"}),"."]})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",metastring:'title="azureadapplication.yaml"',children:"apiVersion: nais.io/v1\nkind: AzureAdApplication\nmetadata:\n  name: entraid-reg\n  namespace: ztoperator-demo\nspec:\n  claims:\n    groups:\n      - id: a6578085-e0ee-4168-bf97-1b3026f6f3bd # Kartverket@kartverket.no\n  replyUrls:\n    - url: https://demo-app.atgcp1-sandbox.kartverket.cloud/oauth2/callback\n  secretName: entraid-secret\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",metastring:'title="Resulterende hemmelighet opprettet av Azurerator"',children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: entraid-secret\n  namespace: ztoperator-demo\ntype: Opaque\ndata:\n  AZURE_APP_CERTIFICATE_KEY_ID: ++++++++\n  AZURE_APP_CLIENT_ID: ++++++++\n  AZURE_APP_CLIENT_SECRET: ++++++++\n  AZURE_APP_JWK: ++++++++\n  AZURE_APP_JWKS: ++++++++\n  AZURE_APP_NEXT_CERTIFICATE_KEY_ID: ++++++++\n  AZURE_APP_NEXT_CLIENT_SECRET: ++++++++\n  AZURE_APP_NEXT_JWK: ++++++++\n  AZURE_APP_NEXT_PASSWORD_KEY_ID: ++++++++\n  AZURE_APP_PASSWORD_KEY_ID: ++++++++\n  AZURE_APP_PRE_AUTHORIZED_APPS: ++++++++\n  AZURE_APP_TENANT_ID: ++++++++\n  AZURE_APP_WELL_KNOWN_URL: ++++++++\n  AZURE_OPENID_CONFIG_ISSUER: ++++++++\n  AZURE_OPENID_CONFIG_JWKS_URI: ++++++++\n  AZURE_OPENID_CONFIG_TOKEN_ENDPOINT: ++++++++\n"})}),"\n",(0,i.jsxs)(t.h2,{id:"-skiperator-application",children:["\ud83e\udd16 Skiperator-",(0,i.jsx)(t.code,{children:"Application"})]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"demo-app"})," er bygget til et Docker-image og lastet opp p\xe5 GitHub Container Registry med f\xf8lgende image-url: ",(0,i.jsx)(t.code,{children:"ghcr.io/kartverket/skip-tilgangsstyring-demo"}),". Den kan da deployes p\xe5 SKIP med f\xf8lgende manifest og n\xe5s p\xe5 ",(0,i.jsx)(t.code,{children:"https://demo-app.atgcp1-sandbox.kartverket.cloud"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Den uthevede delen av koden er viktig for at innlogging av sluttbrukere skal fungere. Hvorfor denne konfigurasjonen er viktig etterlates som en oppgave for leseren. Det brukeren ",(0,i.jsx)(t.em,{children:"m\xe5"})," forholde seg til er hvilket ",(0,i.jsx)(t.code,{children:"secretName"})," det skal refereres til. Dette m\xe5 matche en Kuberenetes-hemmelighet som Ztoperator oppretter som har navneformatet ",(0,i.jsx)(t.code,{children:"<NAVN P\xc5 AUTHPOLICY>-envoy-secret"}),". Ettersom ",(0,i.jsx)(t.code,{children:"demo-app"})," sin Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," heter ",(0,i.jsx)(t.code,{children:"auth-policy"}),", blir det korrekt med ",(0,i.jsx)(t.code,{children:'"secretName": "auth-policy-envoy-secret"'}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",metastring:'title="demo-app.yaml"',children:'apiVersion: skiperator.kartverket.no/v1alpha1\nkind: Application\nmetadata:\n  name: demo-app\n  namespace: ztoperator-demo\nspec:\n// diff-add-start\n  podSettings:\n    annotations:\n      sidecar.istio.io/userVolume: \'[\n        {\n          "name": "istio-oauth2",\n          "secret": {\n            "secretName": "auth-policy-envoy-secret" # \ud83d\udc48 M\xe5 matche <NAVN P\xc5 AUTHPOLICY>-envoy-secret\n          }\n        }\n      ]\'\n      sidecar.istio.io/userVolumeMount: \'[\n        {\n          "name": "istio-oauth2",\n          "mountPath": "/etc/istio/config",\n          "readonly": true\n        }\n      ]\'\n// diff-add-end\n  image: ghcr.io/kartverket/skip-tilgangsstyring-demo@sha256:cde1805d4e87b99a6d8d73fd6ed6666eaef1691a598f0377d3a716366cc4c9e8\n  port: 5000\n  ingresses:\n    - demo-app.atgcp1-sandbox.kartverket.cloud\n'})}),"\n",(0,i.jsxs)(t.h2,{id:"\ufe0f-ztoperator-authpolicy",children:["\u26d4\ufe0f Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})]}),"\n",(0,i.jsxs)(t.p,{children:["Vi har n\xe5 registrert en klient hos Microsoft Entra ID ved hjelp av Azurerator, og spunnet opp ",(0,i.jsx)(t.code,{children:"demo-app"}),"som en Skiperator-",(0,i.jsx)(t.code,{children:"Application"}),". Det siste steget er n\xe5 \xe5 beskytte applikasjonen med en Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"}),". F\xf8lgende manifest beskytter ",(0,i.jsx)(t.code,{children:"demo-app"})," og h\xe5ndterer innlogging av brukere opp mot Microsoft Entra ID. Under g\xe5r vi gjennom hvordan og hvorfor vi har konfigurert Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," som vi har gjort."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",metastring:'title="auth-policy.yaml"',children:"apiVersion: ztoperator.kartverket.no/v1alpha1\nkind: AuthPolicy\nmetadata:\n  name: auth-policy\n  namespace: ztoperator-demo\nspec:\n  enabled: true\n  selector:\n    matchLabels:\n      app: demo-app\n  wellKnownURI: https://login.microsoftonline.com/7f74c8a2-43ce-46b2-b0e8-b6306cba73a3/v2.0/.well-known/openid-configuration\n  audience:\n    - dcc29452-1fbc-4805-aeb9-cdb8f4e62147\n  ignoreAuthRules:\n    - paths:\n        - /*\n  authRules:\n    - paths:\n        - /api/beskyttet*\n      methods:\n        - POST\n      denyRedirect: true\n    - paths:\n        - /beskyttet\n  autoLogin:\n    enabled: true\n    loginPath: /login\n    logoutPath: /logout\n    redirectPath: /oauth2/callback\n    scopes:\n      - dcc29452-1fbc-4805-aeb9-cdb8f4e62147/.default\n  oAuthCredentials:\n    clientIDKey: AZURE_APP_CLIENT_ID\n    clientSecretKey: AZURE_APP_CLIENT_SECRET\n    secretRef: entraid-secret\n  outputClaimToHeaders:\n    - claim: preferred_username\n      header: x-email\n    - claim: name\n      header: x-name\n"})}),"\n",(0,i.jsx)(t.h3,{id:"specenabled",children:(0,i.jsx)(t.code,{children:"spec.enabled"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.enabled"})," lar deg toggle om tilgangsstyring skal v\xe6re aktivert eller ikke."]}),"\n",(0,i.jsx)(t.h3,{id:"specselector",children:(0,i.jsx)(t.code,{children:"spec.selector"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.selector"})," spesifiserer hvilke ",(0,i.jsx)(t.code,{children:"pod"}),"-er som skal beskyttes. N\xe5r man deployer en applikasjon med Skiperator s\xe5 vil alle ",(0,i.jsx)(t.code,{children:"pod"}),"-er f\xe5 labelen ",(0,i.jsx)(t.code,{children:"app: <NAVN P\xc5 SKIPERTOR-APPLICATION>"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"specwellknownuri",children:(0,i.jsx)(t.code,{children:"spec.wellKnownURI"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.wellKnownURI"})," trengs for \xe5 utf\xf8re ",(0,i.jsx)(t.a,{href:"https://swagger.io/docs/specification/v3_0/authentication/openid-connect-discovery/",children:"OpenID Connect Discovery"})," og hente ut relevant informasjon om identitetstilbyderren brukt under autentisering. Det er her man knytter Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," til en identitetstilbyder."]}),"\n",(0,i.jsx)(t.h3,{id:"specaudience",children:(0,i.jsx)(t.code,{children:"spec.audience"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.audience"})," spesifiserer tiltenkt mottaker av aksess-tokenet. Dette er typisk en klient-ID eller en annen unik identifikator knyttet til klientregistreringen utf\xf8rt tidligere. Dette feltet et viktig \xe5 inkludere for \xe5 skille klientregistreringer hos en identitetstilbyder fra andre. ",(0,i.jsx)(t.code,{children:"spec.audience"})," sikrer at kun din klientregistrering kan bruke tokenet til \xe5 aksessere applikasjonens beskyttede endepunkter."]}),"\n",(0,i.jsx)(t.h3,{id:"specignoreauthrules",children:(0,i.jsx)(t.code,{children:"spec.ignoreAuthRules"})}),"\n",(0,i.jsxs)(t.p,{children:["I utgangspunktet er alle endepunkter mot ",(0,i.jsx)(t.code,{children:"demo-app"})," ",(0,i.jsx)(t.em,{children:"\xe5pne"}),", noe som angis med ",(0,i.jsx)(t.code,{children:"paths: [/*]"}),". N\xe5r HTTP-verb ikke er spesifisert, gjelder regelen for alle metoder. Dersom et endepunkt ikke er eksplisitt definert \u2013 eller det finnes overlapp mellom ",(0,i.jsx)(t.code,{children:"spec.ignoreAuthRules"})," og ",(0,i.jsx)(t.code,{children:"spec.authRules"})," \u2013 vil Ztoperator alltid falle tilbake til \xe5 beskytte endepunktet."]}),"\n",(0,i.jsx)(t.h3,{id:"specauthrules",children:(0,i.jsx)(t.code,{children:"spec.authRules"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"POST"})," mot endpunktene ",(0,i.jsx)(t.code,{children:"/api/beskyttet*"})," (",(0,i.jsx)(t.code,{children:"/api/beskyttet"})," og alle under-stier) skal v\xe6re ",(0,i.jsx)(t.em,{children:"beskyttet"}),". Ettersom kall mot ",(0,i.jsx)(t.code,{children:"/api/beskyttet*"})," gj\xf8res av en ",(0,i.jsx)(t.a,{href:"https://www.w3schools.com/xml/ajax_intro.asp",children:"Single Page Application i en AJAX-request"}),", har man ikke muligheten til \xe5 f\xf8lge ",(0,i.jsx)(t.code,{children:"302 Redirect"})," og logge inn brukeren automatisk. For \xe5 l\xf8se dette kan man spesifisere ",(0,i.jsx)(t.code,{children:"denyRedirect: true"})," for \xe5 forhindre at Ztoperator returnerer en ",(0,i.jsx)(t.code,{children:"302 Redirect"})," (den sender da en ",(0,i.jsx)(t.code,{children:"401 Unauthorized"})," i stedet), og heller omdirigere brukeren selv i frontend-koden til den konfigurerte innloggingsstien (",(0,i.jsx)(t.code,{children:"/login"})," i dette tilfellet). Stien ",(0,i.jsx)(t.code,{children:"/beskyttet"})," skal ogs\xe5 beskyttes, og ettersom det ikke spesifiseres ",(0,i.jsx)(t.code,{children:"denyRedirect: true"})," vil uautentiserte brukere automatisk bli omdirigert til innlogging mot Microsoft Entra ID."]}),"\n",(0,i.jsx)(t.h3,{id:"specautologin",children:(0,i.jsx)(t.code,{children:"spec.autoLogin"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.autoLogin"})," lar deg konfigurere innlogging mot identitetstilbyderen. Innlogging vil bli gjort automatisk hvis brukere aksesserer beskyttede endepunkt uten en sesjon (med mindre ",(0,i.jsx)(t.code,{children:"spec.authRules[].denyRedirect"})," er satt til ",(0,i.jsx)(t.code,{children:"true"}),"). I tillegg konfigureres det en dedikert innloggingssti som brukere kan navigeres til for \xe5 starte en inlogget sesjon."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.autoLogin.enabled"})," lar deg toggle om innlogging skal v\xe6re aktivert eller ikke."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.autoLogin.loginPath"})," spesifiserer hvilken sti man skal aksessere for \xe5 starte en innlogget sesjon. Etter vellykket innlogging vil en foresp\xf8rsel sendes til den konfigurerte innloggingsstien i applikasjonen din, og det er da opp til deg \xe5 h\xe5ndtere hva som skal skje."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.autoLogin.logoutPath"})," spesifiserer hvilken sti man skal aksessere for \xe5 logge ut brukeren lokalt og opp mot den konfigurerte identitetstilbyderen (",(0,i.jsx)(t.a,{href:"https://openid.net/specs/openid-connect-rpinitiated-1_0.html",children:"RP-initiated logout"}),"). Etter vellykket utlogging vil brukeren bli omdirigert til nettsiden sin rotsti (dvs. ",(0,i.jsx)(t.code,{children:"https://<HOST>/"}),")."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.autoLogin.redirectPath"})," spesifiserer omdirigeringssti brukt under ",(0,i.jsx)(t.em,{children:"Authorization Code Flow"}),". Dette er en sti som du ",(0,i.jsx)(t.strong,{children:"ikke"})," tregner \xe5 h\xe5ndtere i applikasjonskoden din, men den m\xe5 samsvare med en av de konfigurerte omdirigeringsstiene i klientregistreringen din."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.autoLogin.scopes"})," spesifiserer hvilke scopes som skal brukes i under ",(0,i.jsx)(t.em,{children:"Authorization Code Flow"}),". I dette eksempelet er det spesifisert som ",(0,i.jsx)(t.code,{children:"<CLIENT ID>/.default"}),", som er et scope Microsoft Entra ID tilbyr som implisitt inneholder alle tilgjengelige scopes for klientregistreringen."]}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"warning",children:(0,i.jsxs)(t.p,{children:["Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," benytter seg av cookies for \xe5 lagre innlogget sesjon i nettleseren. ",(0,i.jsx)(t.a,{href:"https://docs.digdir.no/docs/idporten/oidc/oidc_func_sso.html#single-logout-slo",children:"OIDC Single Logout (SLO)"})," benytter seg av ",(0,i.jsx)(t.code,{children:"iframe"})," for \xe5 logge brukeren ut av alle nettstedene som brukeren har en aktiv SSO-sesjon hos. Ettersom cookies som Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," setter er HTTP-only s\xe5 vil de ikke kunne aksesseres i en ",(0,i.jsx)(t.code,{children:"iframe"}),", og SLO er derfor ikke st\xf8ttet av Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"}),"."]})}),"\n",(0,i.jsx)(t.h3,{id:"specoauthcredentials",children:(0,i.jsx)(t.code,{children:"spec.oAuthCredentials"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.oAuthCredentials"})," spesifiserer hvilken klient-ID og klient-hemmelighet som skal brukes under innlogging av brukere."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.oAuthCredentials.secretRef"})," spesifiserer hvilken Kubernetes-hemmelighet som har hemmelightene."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.oAuthCredentials.clientIDKey"})," spesifiserer hvilken data-n\xf8kkel i Kuberenetes-hemmeligheten som har klient-IDen."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"spec.oAuthCredentials.clientSecretKey"})," spesifiserer hvilken data-n\xf8kkel i Kuberenetes-hemmeligheten som har klient-hemmeligheten."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"specoutputclaimtoheaders",children:(0,i.jsx)(t.code,{children:"spec.outputClaimToHeaders"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"spec.outputClaimToHeaders"})," spesifiserer hvilke claims i ",(0,i.jsx)(t.code,{children:"access_token"})," som skal sendes som HTTP-headers til applikasjonen."]}),"\n",(0,i.jsx)(t.h2,{id:"-lett-\xe5-overse",children:"\ud83d\udc40 Lett \xe5 overse"}),"\n",(0,i.jsxs)(t.p,{children:["Selv om Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," skal gj\xf8re det lettere \xe5 sikre appllikasjonen sin med OAuth 2.0 og OIDC, s\xe5 er det fortsatt enkelte ting man lett kan overse."]}),"\n",(0,i.jsx)(t.h3,{id:"audience-begrensing-i-id-porten-og-maksinporten",children:"Audience-begrensing i ID-porten og Maksinporten"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://docs.digdir.no/docs/idporten/oidc/oidc_func_aud.html",children:"B\xe5de ID-porten og Maksinporten benytter seg av audience-begrensing"}),", en mekanisme basert p\xe5 ",(0,i.jsx)(t.a,{href:"https://tools.ietf.org/html/rfc8707",children:"RFC 8707 Resource Indicators for Oauth2"}),", som motvirker at tokens kan misbrukes mot andre APIer enn de som er tiltenkt. En konsekvens av dette er at det er klienten sitt ansvar \xe5 be om et audience-begrenset token. Dette er st\xf8ttet i Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"})," med feltet ",(0,i.jsx)(t.code,{children:"spec.acceptedResources"}),". Dette feltet spesifiserer hvilke APIer tokenet skal kunne brukes mot."]}),"\n",(0,i.jsx)(t.h3,{id:"client-authentication",children:"Client authentication"}),"\n",(0,i.jsxs)(t.p,{children:["Per n\xe5 st\xf8tter Ztoperator kun \xe5 autentisere klienter ved bruk av ",(0,i.jsx)(t.code,{children:"client_secret_post"}),". Selve klient-autentiseringen gj\xf8res av Ztoperator, men det er viktig at det er konfigurert i klientregistreringen mot identitetstilbyderen at man bruker ",(0,i.jsx)(t.code,{children:"client_secret_post"}),"."]}),"\n",(0,i.jsx)(t.admonition,{type:"caution",children:(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"../klientregistrering#-digdirator",children:"Klientregistrering med Digdirator"})," antar at klienten ",(0,i.jsx)(t.em,{children:"kun"})," benytter seg av ",(0,i.jsx)(t.code,{children:"private_key_jwt"})," som klient-autentiseringsmetode, noe som gj\xf8r at klientintegrasjoner satt opp med Digdirator per n\xe5 ikke er kompatibelt med Ztoperator-",(0,i.jsx)(t.code,{children:"AuthPolicy"}),"."]})})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);