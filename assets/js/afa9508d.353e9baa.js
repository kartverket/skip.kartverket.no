"use strict";(self.webpackChunkskip_docs=self.webpackChunkskip_docs||[]).push([[8519],{28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var r=t(96540);const i={},o=r.createContext(i);function s(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}},30850:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"kom-i-gang/praktisk-intro/kubernetes/autentisering-mot-gcp-fra-applikasjon","title":"Autentisering mot GCP fra applikasjon p\xe5 SKIP","description":"1. Opprett Servicekonto","source":"@site/docs/02-kom-i-gang/06-praktisk-intro/06-kubernetes/05-autentisering-mot-gcp-fra-applikasjon.md","sourceDirName":"02-kom-i-gang/06-praktisk-intro/06-kubernetes","slug":"/kom-i-gang/praktisk-intro/kubernetes/autentisering-mot-gcp-fra-applikasjon","permalink":"/docs/kom-i-gang/praktisk-intro/kubernetes/autentisering-mot-gcp-fra-applikasjon","draft":false,"unlisted":false,"editUrl":"https://github.com/kartverket/skip-docs/edit/main/docs/02-kom-i-gang/06-praktisk-intro/06-kubernetes/05-autentisering-mot-gcp-fra-applikasjon.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Bruk av porter i pods","permalink":"/docs/kom-i-gang/praktisk-intro/kubernetes/bruk-av-porter-i-pods"},"next":{"title":"Helsesjekker i Kubernetes","permalink":"/docs/kom-i-gang/praktisk-intro/kubernetes/helsesjekker-i-kubernetes"}}');var i=t(74848),o=t(28453);const s={},a="Autentisering mot GCP fra applikasjon p\xe5 SKIP",c={},l=[{value:"1. Opprett Servicekonto",id:"1-opprett-servicekonto",level:2},{value:"2. Gi WIF IAM Policy til Servicekonto",id:"2-gi-wif-iam-policy-til-servicekonto",level:2},{value:"3. Legg inn config i Skiperatormanifest",id:"3-legg-inn-config-i-skiperatormanifest",level:2},{value:"Alternativ til 1 / 2",id:"alternativ-til-1--2",level:2}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"autentisering-mot-gcp-fra-applikasjon-p\xe5-skip",children:"Autentisering mot GCP fra applikasjon p\xe5 SKIP"})}),"\n",(0,i.jsx)(n.h2,{id:"1-opprett-servicekonto",children:"1. Opprett Servicekonto"}),"\n",(0,i.jsx)(n.p,{children:"Dersom man \xf8nsker \xe5 f\xe5 tilgang til GCP-tjenester fra Kubernetes gj\xf8res dette med \xe5 f\xf8rst opprette en servicekonto i GCP og \xe5 gi den IAM-rettigheter til det man \xf8nsker at den skal gj\xf8re."}),"\n",(0,i.jsx)(n.admonition,{type:"danger",children:(0,i.jsx)(n.p,{children:"Det er sterkt anbefalt \xe5 opprette en dedikert servicekonto for hver applikasjon eller tjeneste som trenger tilgang til GCP-ressurser, slik at man f\xf8lger least-privilege prinsippet.\nHvis man benytter seg av deploy-kontoen direkte i en pod, og denne har f\xe5tt mange rettigheter, kan et eventuelt sikkerhetsbrudd i applikasjonen f\xf8re til at en angriper f\xe5r tilgang til alle ressursene som deploy-kontoen har tilgang til."})}),"\n",(0,i.jsxs)(n.p,{children:["Servicekontoer b\xf8r opprettes med terraform ved hjelp av en deploy-konto man f\xe5r opprettet via ",(0,i.jsx)(n.a,{href:"https://github.com/kartverket/gcp-service-accounts",children:"gcp-service-accounts"})," repoet til SKIP."]}),"\n",(0,i.jsx)(n.h2,{id:"2-gi-wif-iam-policy-til-servicekonto",children:"2. Gi WIF IAM Policy til Servicekonto"}),"\n",(0,i.jsxs)(n.p,{children:["For \xe5 autentisere som denne GCP-servicekontoen fra Kubernetes m\xe5 Kubernetes-servicekontoen gis tilganger til det. Dette gj\xf8res ved \xe5 gi Kubernetes-servicekontoen rollen ",(0,i.jsx)(n.code,{children:"iam.workloadIdentityUser"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Forklaring p\xe5 bruk av variabler i kommandoen nedenfor:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GCP_SA_NAME - Navnet p\xe5 GCP servicekontoen\nGCP_SA_PROJECT_ID - GCP Project ID til prosjektet GCP SA ligger i\nKUBERNETES_PROJECT_ID - GCP Project ID for Kubernetes-cluster (for eksempel `kubernetes-dev-94b9` for dev-clusteret eller `kubernetes-prod-e4a2` for prod-clusteret)\nKUBERNETES_NAMESPACE - Kubernetes namespace hvor servicekontoen er opprettet\nKUBERNETES_SA_NAME - Kubernetes service account som brukes av en Pod - Samme navn som Application-manifestet (for SKIPJob'er legges det til et suffix `-skipjob`).\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Kj\xf8r f\xf8lgende kommando med ",(0,i.jsx)(n.code,{children:"gcloud"})," CLI:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'gcloud iam service-accounts add-iam-policy-binding \\\n  GCP_SA_NAME@GCP_SA_PROJECT_ID.iam.gserviceaccount.com \\\n  --role=roles/iam.workloadIdentityUser \\\n  --member="serviceAccount:KUBERNETES_PROJECT_ID.svc.id.goog[KUBERNETES_NAMESPACE/KUBERNETES_SA_NAME]"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["For en SKIPJob f\xe5r kubernetes service accounten navnet ",(0,i.jsx)(n.code,{children:"KUBERNETES_SA_NAME-skipjob"})," og member i eksempelet over blir ",(0,i.jsx)(n.code,{children:"serviceAccount:KUBERNETES_PROJECT_ID.svc.id.goog[KUBERNETES_NAMESPACE/KUBERNETES_SA_NAME-skipjob]"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"3-legg-inn-config-i-skiperatormanifest",children:"3. Legg inn config i Skiperatormanifest"}),"\n",(0,i.jsxs)(n.p,{children:["Til slutt legger man til ",(0,i.jsx)(n.code,{children:"gcp"})," config i sin skiperator Application for \xe5 lage kubernetes-config slik at podden kan autentisere mot GCP."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"spec:\n  gcp:\n    auth:\n      serviceAccount: GCP_SA_NAME@GCP_SA_PROJECT_ID.iam.gserviceaccount.com\n"})}),"\n",(0,i.jsxs)(n.p,{children:["N\xe5 kan man f\xf8lge \u201cAuthenticate from your code\u201d under ",(0,i.jsx)(n.a,{href:"https://cloud.google.com/anthos/fleet-management/docs/use-workload-identity#-python",children:"https://cloud.google.com/anthos/fleet-management/docs/use-workload-identity#-python"})," for \xe5 autentisere mot GCP fra koden sin."]}),"\n",(0,i.jsx)(n.p,{children:"N\xe5r dette er gjort kan applikasjonen snakke med GCP under runtime."}),"\n",(0,i.jsx)(n.h2,{id:"alternativ-til-1--2",children:"Alternativ til 1 / 2"}),"\n",(0,i.jsx)(n.p,{children:"Dersom man ikke \xf8nsker \xe5 legge til roller manuelt har SKIP lagt til en ny m\xe5te \xe5 legge til Workload Identity User p\xe5 en service account, ved hjelp av Crossplane."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: 'skip.kartverket.no/v1alpha1'\nkind: 'WorkloadIdentityInstance'\nmetadata:\n  name: 'service-account-wi'\nspec:\n  parameters:\n    gcpKubernetesProject: 'some-kubernetes-project' #eks: 'kubernetes-dev-94b9'\n    gcpProject: 'gcp-project-where-service-account-is' #eks: 'dsa-dev-e32c'\n    gcpServiceAccount: 'name-of-service-account-in-gcp' #eks: 'dsa-runtime@dsa-dev-e32c.iam.gserviceaccount.com'\n    serviceAccount: 'name-of-service-account-in-kubernetes' #eks 'dsa-backend', typically same name as your Application\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Se ",(0,i.jsx)(n.a,{href:"/docs/applikasjon-utrulling/argo-cd/provisjonere-infrastruktur-med-crossplane",children:"Provisjonere infrastruktur med Crossplane"})," om du ikke har brukt Crossplane tidligere."]})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}}}]);