"use strict";(self.webpackChunkskip_docs=self.webpackChunkskip_docs||[]).push([[7226],{83174:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"lagring/cloud-sql","title":"Cloud SQL for PostgreSQL","description":"Oppsett av instanser med terraform","source":"@site/docs/06-lagring/03-cloud-sql.md","sourceDirName":"06-lagring","slug":"/lagring/cloud-sql","permalink":"/docs/lagring/cloud-sql","draft":false,"unlisted":false,"editUrl":"https://github.com/kartverket/skip-docs/edit/main/docs/06-lagring/03-cloud-sql.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Objektlagring med Scality S3","permalink":"/docs/lagring/objektlagring-scality-s3"},"next":{"title":"\ud83d\udd2d Observabilitet","permalink":"/docs/observability/"}}');var a=r(74848),s=r(28453);const i={},l="Cloud SQL for PostgreSQL",o={},d=[{value:"Oppsett av instanser med terraform",id:"oppsett-av-instanser-med-terraform",level:2},{value:"cloud_sql modulen",id:"cloud_sql-modulen",level:3},{value:"cloud_sql_config modulen og konfigurering av brukere",id:"cloud_sql_config-modulen-og-konfigurering-av-brukere",level:3},{value:"Bruke instansen fra SKIP",id:"bruke-instansen-fra-skip",level:2},{value:"Bruke CloudSQL fra Java applikasjoner",id:"bruke-cloudsql-fra-java-applikasjoner",level:3},{value:"Monitorering og alarmering",id:"monitorering-og-alarmering",level:2},{value:"Backup og katastrofeh\xe5ndtering",id:"backup-og-katastrofeh\xe5ndtering",level:2},{value:"Backup",id:"backup",level:3},{value:"Katastrofeh\xe5ndtering",id:"katastrofeh\xe5ndtering",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"cloud-sql-for-postgresql",children:"Cloud SQL for PostgreSQL"})}),"\n",(0,a.jsx)(n.h2,{id:"oppsett-av-instanser-med-terraform",children:"Oppsett av instanser med terraform"}),"\n",(0,a.jsxs)(n.p,{children:["SKIP har laget to terraform-moduler (",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/tree/main/cloud_sql",children:"cloud_sql"})," og\n",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/tree/main/cloud_sql_config",children:"cloud_sql_config"}),") for \xe5 gj\xf8re det enkelt \xe5\nsette opp nye Cloud SQL-instanser i GCP."]}),"\n",(0,a.jsxs)(n.p,{children:["Dokumentasjon for hvordan modulene brukes finnes p\xe5 wiki-siden til ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/wiki",children:"terraform-modules"}),"\nSpesielt guiden for ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/wiki/Hvordan-bruke-dette-repoet",children:"hvordan bruke terraform-modules repoet"})," er relevant."]}),"\n",(0,a.jsx)(n.h3,{id:"cloud_sql-modulen",children:"cloud_sql modulen"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["For mer utfyllende dokumentasjon se ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/tree/main/cloud_sql",children:"cloud_sql wiki"})]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",children:'module "cloudsql_test" {\n  source        = "git@github.com:kartverket/terraform-modules.git/?ref=cloud_sql/v0.10.0"\n  env           = "sandbox"\n  instance_name = "foo-db"\n  project_id    = "skip-sandbox-37c2"\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Du kan koble deg til p\xe5 denne m\xe5ten:"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"JIT deg til cloudsql.admin"}),"\n",(0,a.jsxs)(n.li,{children:["Last ned ",(0,a.jsx)(n.a,{href:"https://cloud.google.com/sql/docs/postgres/connect-instance-auth-proxy#install-proxy",children:"cloudsql-proxy"})]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.code,{children:"gcloud auth application-default login"})}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"./cloud-sql-proxy --private-ip <connection-name> --auto-iam-authn"})," -- connection name finner du p\xe5 sql instansen i GCP"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"psql -d admin -h localhost -U admin"})," eller fra applikasjon"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Du m\xe5 v\xe6re p\xe5 Kartverkets nettverk for \xe5 f\xe5 tilgang, selv med cloud sql proxy. Man kan ikke koble til fra egen klient uten proxy.\nDu trenger ikke \xe5 bruke SSL sertifikater n\xe5r du kobler til via proxy."}),"\n",(0,a.jsx)(n.h3,{id:"cloud_sql_config-modulen-og-konfigurering-av-brukere",children:"cloud_sql_config modulen og konfigurering av brukere"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["For mer utfyllende dokumentasjon se ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/wiki/cloud_sql_config",children:"cloud_sql_config wiki"})]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:['Denne modulen er laget for konfigurasjon av postgres instanser. Vi har laget denne for \xe5 gj\xf8re konfigurering av databaser enklest mulig for dere,\nog for \xe5 unng\xe5 "click-ops".',(0,a.jsx)(n.br,{}),"\n","Det er noen ting dere b\xf8r tenke over f\xf8r dere tar denne i bruk:"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Den burde bare brukes p\xe5 en ny instans. \xc5 importere eksisterende databaser, brukere og skjemaer er noe vi frar\xe5der"}),"\n",(0,a.jsx)(n.li,{children:"Feil bruk av denne modulen kan slette brukere, secrets og hele databasen inkludert all data. Sjekk alltid PLAN f\xf8r du applyer."}),"\n",(0,a.jsx)(n.li,{children:"V\xe6r sikker p\xe5 at migreringene dine er kompatible med modulen mtp. privileges"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Eksempel config:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-hcl",children:'module "cloudsql_config" {\n  source            = "git@github.com:kartverket/terraform-modules.git/?ref=cloud_sql_config/v0.7.0"\n  gcp_instance_name = module.cloudsql_test.cloud_sql_instance_name\n  gcp_project_id    = module.cloudsql_test.gcp_project_id\n  env               = "prod"\n  databases = {\n    "backstage" = {\n      name            = "backstage"\n      owner           = "backstage"\n      extensions      = ["pgcrypto", "postgis"]\n      prevent_destroy = true\n      # Denne variabelen m\xe5 IKKE endres uten at dere er klare til \xe5 migrere state manuelt.\n      schemas = [\n        {\n          name = "backstage"\n          migration_user = {\n            name = "backstage_migrater" # migration_user blir eier av skjemaet som opprettes\n          }\n          application_user = {\n            name = "backstage_app" # application user f\xe5r CRUD privilegier\n          }\n          misc_users = [\n            {\n              name       = "readonly"\n              privileges = ["SELECT"]\n            }\n          ]\n        },\n        {\n          name         = "opencost"\n          unified_user = true\n          migration_user = {\n            name = "opencost_migrater" # ignoreres, fordi vi har unified_user = true, men den m\xe5 settes likevel\n          }\n          application_user = {\n            name       = "opencost_app"\n            privileges = ["SELECT", "UPDATE"] # ignoreres, app user blir owner av skjemaet fordi unified_user er true\n          }\n          misc_users = [\n            {\n              name       = "readonly"\n              privileges = ["SELECT"]\n            }\n          ]\n        }\n      ]\n    }\n  }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"For hver bruker s\xe5 vil modulen generere opp et klient sertifikat og en privatn\xf8kkel, disse legges i GSM.\nDen private n\xf8kkelen legges i to formater; PEM og PK8. Vi har erfart at JDBC ikke liker PEM, s\xe5 i dette tilfellet\ns\xe5 b\xf8r du bruke PK8 n\xf8kkelen istedenfor."}),"\n",(0,a.jsx)(n.h2,{id:"bruke-instansen-fra-skip",children:"Bruke instansen fra SKIP"}),"\n",(0,a.jsx)(n.p,{children:"N\xe5r du skal bruke instansen fra SKIP s\xe5 m\xe5 du gj\xf8re noen f\xe5 modifikasjoner til applikasjonsmanifestet ditt."}),"\n",(0,a.jsx)(n.p,{children:"Det f\xf8rste du m\xe5 gj\xf8re er \xe5 hente ut secrets."}),"\n",(0,a.jsx)(n.p,{children:"Terraform modulen vil generere opp og legge inn alle secrets du trenger for \xe5\nkoble til databasen i Google Secret Manager i prosjektet du har valgt."}),"\n",(0,a.jsxs)(n.p,{children:["Kjenner du ikke til GSM og ExternalSecrets anbefaler vi \xe5 lese ",(0,a.jsx)(n.a,{href:"/docs/applikasjon-utrulling/argo-cd/hente-hemmeligheter-fra-hemmelighetsvelv",children:"Hente hemmeligheter fra hemmelighetshvelv"})," f\xf8rst."]}),"\n",(0,a.jsxs)(n.p,{children:["For \xe5 hente ut disse s\xe5 m\xe5 du lage to ",(0,a.jsx)(n.code,{children:"ExternalSecret"}),", en for sertifikater og en for passord/brukernavn, her er et eksempel:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: external-secrets.io/v1beta1\nkind: ExternalSecret\nmetadata:\n  name: minapp-hemmligheter\nspec:\n  secretStoreRef:\n    kind: SecretStore\n    name: gsm\n  data:\n    - secretKey: db_password\n      remoteRef:\n        key: cloudsql-<instansnavn>-<bruker>-password\n\n--- \n\napiVersion: external-secrets.io/v1beta1\nkind: ExternalSecret\nmetadata:\n  name: database-certs\nspec:\n  secretStoreRef:\n    kind: SecretStore\n    name: gsm\n  data:\n    - secretKey: server.crt\n      remoteRef:\n        key: cloudsql-<instansnavn>-ca-certificate\n    - secretKey: client.crt\n      remoteRef:\n        key: cloudsql-<instansnavn>-<bruker>-client-certificate\n        \n    ### client.key i PEM, fungerer for de fleste\n    - secretKey: client.key\n      remoteRef:\n        key: cloudsql-<instansnavn>-<bruker>-client-key\n    \n    ### VISST DU TRENGER PK8 (JDBC kan kreve dette) - Bare ta med \xc8N key, ikke begge\n    - secretKey: client.pk8\n      remoteRef:\n        decodingStrategy: Base64 # M\xe5 v\xe6re med for pk8\n        key: cloudsql-<instansnavn>-<bruker>-client-key-pk8\n"})}),"\n",(0,a.jsx)(n.p,{children:"N\xe5 har du hentet alle hemmelighetene du trenger, og kan bruke disse i skiperator manifestet ditt:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: skiperator.kartverket.no/v1alpha1\nkind: Application\nmetadata:\n  name: minapp\nspec:\n  image: ghcr.io/kartverket/minapp\n  port: 8080\n  replicas: 2\n  accessPolicy:\n    outbound:\n      external:\n      - host: <instansnavn>-db-<env>  # Velg selv hva du vil kalle denne, s\xe5 lenge den er unik\n        ip: 10.x.x.x # Privat IP-adresse til databasen, den finner du i GCP\n        ports:\n          - name: sql\n            port: 5432\n            protocol: TCP\n  env:  ## DISSE env VERDIENE ER EKSEMPLER, OG M\xc5 JUSTERES FOR HVER APPLIKASJON\n    - name: POSTGRES_DB\n      value: minapp\n    - name: POSTGRES_USER\n      value: minappbrukernavn\n    - name: POSTGRES_PASSWORD\n      valueFrom:\n        secretKeyRef:\n          key: db_password\n          name: minapp-hemmligheter\n    - name: PGSSLCA\n      value: /app/db-certs/server.crt\n    - name: PGSSLKEY\n      value: /app/db-certs/client.key\n    - name: PGSSLCERT\n      value: /app/db-certs/client.crt\n  filesFrom:\n  - mountPath: /app/db-certs\n    secret: database-certs\n"})}),"\n",(0,a.jsx)(n.p,{children:"Skiperator vil n\xe5:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["lage en ",(0,a.jsx)(n.code,{children:"NetworkPolicy"})," som gir applikasjonen tilgang til databasen"]}),"\n",(0,a.jsx)(n.li,{children:"'mounte' sertifikatene inn i filsystemet til poden, slik applikasjonen kan bruke de til \xe5 koble til databasen"}),"\n",(0,a.jsx)(n.li,{children:"laste inn passord hemmeligheten som en env variabel inn i poden, slik applikasjonen kan koble til databasen"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"bruke-cloudsql-fra-java-applikasjoner",children:"Bruke CloudSQL fra Java applikasjoner"}),"\n",(0,a.jsxs)(n.p,{children:["Skal du bruke CloudSQL fra Java applikasjoner m\xe5 du lage til ExternalSecrets og konfigurere skiperator som ovenfor,\nmen bruk pk8 n\xf8kkel istedenfor vanlig pem n\xf8kkel.\nDet skal v\xe6re nok \xe5 konfigurere en connection string som ser noe slik ut ",(0,a.jsx)(n.code,{children:"postgresql://<privat-ip>:5432/<database-navn>?sslmode=require&sslrootcert=/app/db-certs/server.crt&sslcert=/app/db-certs/client.crt&sslkey=/app/db-certs/client.pk8"})]}),"\n",(0,a.jsxs)(n.p,{children:["Alternativt kan man ogs\xe5 bruke en ",(0,a.jsx)(n.a,{href:"https://cloud.google.com/sql/docs/postgres/connect-auth-proxy#languages",children:"Cloud Sql Auth Proxy connector"}),", men da vil man f\xe5 litt d\xe5rligere ytelse.\nBruker man en connector s\xe5 slipper man \xe5 bruke certs, men man m\xe5 \xe5pne for port 3307 mot databasen i access policies i skiperator manifestet."]}),"\n",(0,a.jsx)(n.h2,{id:"monitorering-og-alarmering",children:"Monitorering og alarmering"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Fungerer bare dersom dere bruker h\xf8yere versjon enn 0.9.1 av ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/wiki/cloud_sql",children:"cloud_sql"})," modulen."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Vi har laget et dashboard, sammen med DBAene, for monitorering av CloudSQL databasene, som kan finne ",(0,a.jsx)(n.a,{href:"https://monitoring.kartverket.cloud/d/aek9kpwgzv280f/dba-cloudsql?orgId=1&from=now-30m&to=now&timezone=browser&var-Env=prod&var-ProjectID=utviklerportal-prod-ba53&var-Instance=backstage-prod",children:"her"}),".\nI tillegg s\xe5 finnes ogs\xe5 Googles standard dashboard og metrikker som man kan finne inne p\xe5 CloudSQL ressursen i GCP consolen."]}),"\n",(0,a.jsxs)(n.p,{children:["For alarmering s\xe5 brukes ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/grafana-alerts",children:"grafana-alerts"})," repoet som for alle andre type alerts.\nHer har vi utviklet en ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/grafana-alerts/tree/main/modules/cloud_sql_alerts",children:"cloud_sql_alerts"})," modul som gir dere et sett med standard alarmer.\nMetrikker vi baserer oss p\xe5 blir hentet ut ved hjelp av ",(0,a.jsx)(n.a,{href:"https://github.com/justwatchcom/sql_exporter",children:"sql_exporter"}),", disse metrikkene er hentet ut p\xe5 grunnlag av SQL-sp\xf8rringer som DBAene har predefinert.\n\xd8nskes det andre metrikker s\xe5 ta kontakt med dem."]}),"\n",(0,a.jsxs)(n.p,{children:["Det er ogs\xe5 tilgjengelig et sett med standardmetrikker fra Google gjennom grafana, for \xe5 bruke disse s\xe5 g\xe5 inn i ",(0,a.jsx)(n.a,{href:"https://monitoring.kartverket.cloud/explore",children:"explore view i grafana"}),".\nVelg ",(0,a.jsx)(n.code,{children:"Google Cloud Monitoring"})," som datasource, og velg prosjektet ditt og Cloudsql som service. Se p\xe5 ",(0,a.jsx)(n.code,{children:"cloud_sql_alerts"})," modulen dersom du \xf8nsker \xe5 se hvordan de kan brukes i en alert."]}),"\n",(0,a.jsx)(n.h2,{id:"backup-og-katastrofeh\xe5ndtering",children:"Backup og katastrofeh\xe5ndtering"}),"\n",(0,a.jsx)(n.h3,{id:"backup",children:"Backup"}),"\n",(0,a.jsxs)(n.p,{children:["CloudSQL er en google managed l\xf8sning av postgres, og det betyr ogs\xe5 at det har et innebygd backup system, og h\xe5ndteres i gcp console.\nDette systemet tar automatisk backup av databasen din, og lagrer disse i 7 dager som standard.  Hvis du har behov for \xe5 bevare backups lengre enn dette kan det konfigureres med en variabel til terraform-modulen, ref: ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/wiki/cloud_sql#input_retained_backups",children:"input_retained_backups"}),"\nBackupen er inkrementel og man har ",(0,a.jsx)(n.code,{children:"Point-in-time"})," recovery tilgjengelig.\nVi anbefaler at du leser gjennom ",(0,a.jsx)(n.a,{href:"https://cloud.google.com/sql/docs/postgres/backup-recovery/backups",children:"Google sin dokumentasjon"})," for \xe5 forst\xe5 hvordan backup fungerer i CloudSQL."]}),"\n",(0,a.jsx)(n.h3,{id:"katastrofeh\xe5ndtering",children:"Katastrofeh\xe5ndtering"}),"\n",(0,a.jsxs)(n.p,{children:["Google Cloud SQL har innebygd failover, og det betyr at dersom prim\xe6rinstansen din g\xe5r ned, s\xe5 vil en av de tilgjengelige replicaene ta over.\nDette m\xe5 konfigureres i terraform, ved bruk av ",(0,a.jsx)(n.code,{children:"availability_type"})," ",(0,a.jsx)(n.a,{href:"https://github.com/kartverket/terraform-modules/wiki/cloud_sql#input_availability_type",children:"variabelen"}),", default p\xe5 denne er ",(0,a.jsx)(n.code,{children:"ZONAL"})," som betyr at du ikke f\xe5r en secondary instans.\nI produksjon er det anbefalt \xe5 ha en secondary instans, og da m\xe5 ",(0,a.jsx)(n.code,{children:"availability_type"})," settes til ",(0,a.jsx)(n.code,{children:"REGIONAL"})," i terraform.\nLes mer her: ",(0,a.jsx)(n.a,{href:"https://cloud.google.com/sql/docs/postgres/high-availability",children:"Google sin dokumentasjon"})]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>l});var t=r(96540);const a={},s=t.createContext(a);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);