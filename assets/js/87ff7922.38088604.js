"use strict";(self.webpackChunkskip_docs=self.webpackChunkskip_docs||[]).push([[380],{28453:(e,t,r)=>{r.d(t,{R:()=>s,x:()=>o});var n=r(96540);const a={},i=n.createContext(a);function s(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),n.createElement(i.Provider,{value:t},e.children)}},62127:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"kom-i-gang/praktisk-intro/kubernetes/certificates-outside-acme","title":"Certificates outside ACME","description":"In some instances there is a requirement to use certificates not from ACME. This might be because DNS points to something other than SKIP LB, and traffic is routed to SKIP via other endpoints in kartverket.","source":"@site/docs/02-kom-i-gang/06-praktisk-intro/06-kubernetes/08-certificates-outside-acme.md","sourceDirName":"02-kom-i-gang/06-praktisk-intro/06-kubernetes","slug":"/kom-i-gang/praktisk-intro/kubernetes/certificates-outside-acme","permalink":"/docs/kom-i-gang/praktisk-intro/kubernetes/certificates-outside-acme","draft":false,"unlisted":false,"editUrl":"https://github.com/kartverket/skip-docs/edit/main/docs/02-kom-i-gang/06-praktisk-intro/06-kubernetes/08-certificates-outside-acme.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"URLer og sertifikat for tjenester p\xe5 SKIP","permalink":"/docs/kom-i-gang/praktisk-intro/kubernetes/urler-og-sertifikat-for-tjenester-p\xe5-skip"},"next":{"title":"End-user IP-Addresses in Containers","permalink":"/docs/kom-i-gang/praktisk-intro/kubernetes/end-user ip-addresses-in-containers"}}');var a=r(74848),i=r(28453);const s={},o="Certificates outside ACME",c={},d=[{value:"Create certificate secret resource in istio-gateways",id:"create-certificate-secret-resource-in-istio-gateways",level:2},{value:"Edit the gateway resource",id:"edit-the-gateway-resource",level:2},{value:"If Skiperator is the gateway creator",id:"if-skiperator-is-the-gateway-creator",level:3},{value:"Change to ACME certificate",id:"change-to-acme-certificate",level:2},{value:"Non-Skiperator apps",id:"non-skiperator-apps",level:3},{value:"Skiperator apps",id:"skiperator-apps",level:3}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"certificates-outside-acme",children:"Certificates outside ACME"})}),"\n",(0,a.jsx)(t.p,{children:"In some instances there is a requirement to use certificates not from ACME. This might be because DNS points to something other than SKIP LB, and traffic is routed to SKIP via other endpoints in kartverket."}),"\n",(0,a.jsx)(t.h2,{id:"create-certificate-secret-resource-in-istio-gateways",children:"Create certificate secret resource in istio-gateways"}),"\n",(0,a.jsx)(t.p,{children:"To be able to use a custom certificate we need a secret to mount to the gateway resource. This is a kubernetes.io/tls type secret and can be created via external secrets like this:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",children:"apiVersion: external-secrets.io/v1\nkind: ExternalSecret\nmetadata:\n  name: star-matrikkel\n  namespace: istio-gateways\nspec:\n  dataFrom:\n  - extract:\n      conversionStrategy: Default\n      decodingStrategy: Auto\n      key: star-matrikkel-no-key\n  refreshInterval: 1h\n  secretStoreRef:\n    kind: SecretStore\n    name: gsm\n  target:\n    creationPolicy: Owner\n    deletionPolicy: Retain\n    name: star-matrikkel # Secret in Kubernetes\n    template:\n      engineVersion: v2\n      mergePolicy: Replace\n      type: kubernetes.io/tls\n"})}),"\n",(0,a.jsx)(t.p,{children:"This fetches the secret from Google Secret Manager. This secret should look like this:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-json",children:'{\n"tls.crt":"[base64 encoded cert chain]",\n"tls.key":"[base64 encoded tls.key]"\n}\n'})}),"\n",(0,a.jsx)(t.h2,{id:"edit-the-gateway-resource",children:"Edit the gateway resource"}),"\n",(0,a.jsx)(t.p,{children:"The gateway resource should then be updated with the new secret:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: gateway-ingress\n  namespace: matrikkel-keycloak\nspec:\n  selector:\n    app: istio-ingress-external\n  servers:\n  - hosts:\n    - auth.matrikkel.no\n    port:\n      name: http\n      number: 80\n      protocol: HTTP\n  - hosts:\n    - auth.matrikkel.no\n    port:\n      name: https\n      number: 443\n      protocol: HTTPS\n    tls:\n      credentialName: star-matrikkel # Secret created by externalsecret\n      mode: SIMPLE\n"})}),"\n",(0,a.jsx)(t.h3,{id:"if-skiperator-is-the-gateway-creator",children:"If Skiperator is the gateway creator"}),"\n",(0,a.jsx)(t.p,{children:'When the gateway is created via Skiperator it will have a credentialName corresponding to the secret created by the certificate from Skiperator. Skiperator will reset configurations to its resources unless the resource labeled \u201cskiperator.kartverket.no/ignore: "true"\u201c. This will make skiperator ignore this specific resource during reconciliation loops.'}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",children:'apiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  labels:\n    skiperator.kartverket.no/ignore: "true"\n'})}),"\n",(0,a.jsx)(t.p,{children:"This is meant to be a temporary solution, and ACME is the prefered way to get certificates in SKIP."}),"\n",(0,a.jsx)(t.h2,{id:"change-to-acme-certificate",children:"Change to ACME certificate"}),"\n",(0,a.jsx)(t.h3,{id:"non-skiperator-apps",children:"Non-Skiperator apps"}),"\n",(0,a.jsxs)(t.p,{children:["Using ACME certificate on a non skiperator app requires a certificate resource, and using the resulting secret in the gateway. This resource must be created in the istio-gateways namespace and therefore in the ",(0,a.jsx)(t.a,{href:"https://github.com/kartverket/skip-apps",children:"skip-apps"})," :"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",children:"apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: certificate-name\n  namespace: istio-gateways\nspec:\n  dnsNames:\n  - appname.kartverket.no\n  issuerRef:\n    kind: ClusterIssuer\n    name: cluster-issuer\n  secretName: desired-secret-name\n"})}),"\n",(0,a.jsx)(t.p,{children:"After this is created and the secret is created, the gateway resource can be edited, and spec.tls.credentialName set to the secret."}),"\n",(0,a.jsx)(t.h3,{id:"skiperator-apps",children:"Skiperator apps"}),"\n",(0,a.jsx)(t.p,{children:'Remove the \u201cskiperator.kartverket.no/ignore: "true"\u201c label, and skiperator will handle the rest.'})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}}}]);